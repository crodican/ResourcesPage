<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Recovery Support Locations</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { width: 100%; height: 500px; }
        .location-links { margin-top: 20px; }
        .location-links button { padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        .map-popup { padding: 10px; }
        .map-popup h3 { margin-top: 0; }
        .custom-marker {
            cursor: pointer;
        }
        .br-5-5-5-5 { border-radius: 5px; } /* Example for a custom class */
        .bg-55298a { background-color: #55298a; } /* Example for a custom class */
        mapImage {
            width: 160px;
            height: auto;
            position: relative;
            
        }
        .card-bottomnav a:hover {
            background-color: #f5ebf3;
            color: #55298a !important;
        }
        
    </style>
</head>
<body>

<div id="map"></div>

<div class="location-links">
    <h3>View Location Details:</h3>
    <p id="loading-message">Loading location data...</p>
    </div>

<script>
    const map = new maplibregl.Map({
        style: 'https://tiles.openfreemap.org/styles/liberty',
        center: [-75.347468, 40.104172],
        zoom: 9.5,
        container: 'map',
        attributionControl: false
    });

    map.addControl(new maplibregl.AttributionControl({
        customAttribution: 'Your Custom Attribution Text Here'
    }), 'bottom-right');

    const locationLinksContainer = document.querySelector('.location-links');
    const loadingMessage = document.getElementById('loading-message');
    let locationsData = [];
    const markers = [];

    fetch('https://resourcesdatabaseproxy.crodican.workers.dev/?limit=999999')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadingMessage.style.display = 'none';

            if (data && Array.isArray(data.list)) {
                locationsData = data.list;
                locationLinksContainer.innerHTML = '<h3>View Location Details:</h3>';

                locationsData.forEach((resource, index) => { // Renamed 'location' to 'resource' for clarity
                    const popupContent = `
                        <div class="map-popup shadow-lg text-bg-white br-5-5-5-5 mb-5" style="max-width: 300px">
                            <div class="row no-gutters p-0">
                                <div class="card-body col-10 p-4">
                                    <h3 class="text-secondary">${resource['Location Name'] || 'N/A'}</h3>
                                    <h5 class="text-dark">${resource.Organization || 'N/A'}</h5>
                                    <h6>Phone: ${resource.Phone || 'N/A'}</h6>
                                    <p>${resource.Address || 'N/A'}
                                        <br> ${resource.City || 'N/A'}, ${resource.State || 'N/A'}, ${resource['Zip Code'] || 'N/A'}
                                        <br /> <strong><a href="${resource['Google Maps URL'] || '#'}" class="text-secondary" target="_blank">Directions</a></strong></p>
                                    <div class="row d-flex justify-content-end position-relative"> ${resource.Image ? `
                                            <div class="col-md-auto d-flex justify-content-end align-items-end p-2" style="position:relative"><img class="mapImage" src="${resource.Image}" alt="Logo" style="position:absolute;height:200px"></div>` : ''} </div>
                                </div>
                            </div>
                            <div class="card-bottomnav col bg-55298a d-flex flex-row no-gutters align-content-stretch justify-content-stretch p-0">
                                <a href="${resource.Website || '#'}" class="d-flex align-items-center justify-content-center flex-grow-1 w-100 h-100 text-white py-1" target="_blank"> <i class="bi bi-globe"></i> </a>
                                <a href="${resource['Phone URL'] || '#'}" class="d-flex align-items-center justify-content-center flex-grow-1 w-100 h-100 text-white py-1"> <i class="bi bi-telephone-fill"></i> </a>
                                <a href="${resource['Google Maps URL'] || '#'}" class="d-flex align-items-center justify-content-center flex-grow-1 w-100 h-100 text-white py-1" target="_blank"> <i class="bi bi-geo-alt-fill"></i> </a>
                            </div>
                        </div>
                    `;

                    const popup = new maplibregl.Popup({ offset: 25 })
                        .setHTML(popupContent);

                    const markerElement = document.createElement('div');
                    markerElement.className = 'custom-marker';

                    const marker = new maplibregl.Marker(markerElement)
                        .setLngLat([parseFloat(resource.Longitude), parseFloat(resource.Latitude)])
                        .setPopup(popup)
                        .addTo(map);

                    markers.push({ marker: marker, index: index });

                    const button = document.createElement('button');
                    button.textContent = resource.County + ' County';
                    button.onclick = () => flyToLocationAndOpenPopup(index);
                    locationLinksContainer.appendChild(button);
                });

                if (locationsData.length > 0) {
                    const bounds = new maplibregl.LngLatBounds();
                    locationsData.forEach(resource => bounds.extend([parseFloat(resource.Longitude), parseFloat(resource.Latitude)]));
                    map.fitBounds(bounds, { padding: 50 });
                }
            } else {
                console.error('Error: Fetched data does not contain a valid list of locations:', data);
                locationLinksContainer.innerHTML = '<p>Error: Invalid location data received.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching location data:', error);
            loadingMessage.style.display = 'none';
            locationLinksContainer.innerHTML = `<p>Error loading location data: ${error.message}</p>`;
        });

    function flyToLocationAndOpenPopup(locationIndex) {
        if (!locationsData[locationIndex]) {
            console.error('Location index out of bounds:', locationIndex);
            return;
        }
        const resource = locationsData[locationIndex]; // Renamed 'location' to 'resource'
        map.flyTo({
            center: [parseFloat(resource.Longitude), parseFloat(resource.Latitude)],
            zoom: 12,
            essential: true
        });

        markers.forEach(item => {
            if (item.index === locationIndex) {
                item.marker.togglePopup();
            } else {
                item.marker.getPopup().remove();
            }
        });
    }

    markers.forEach(item => {
        item.marker.on('click', () => {
            markers.forEach(otherItem => {
                if (otherItem !== item) {
                    otherItem.marker.getPopup().remove();
                }
            });
        });
    });
</script>

</body>
</html>