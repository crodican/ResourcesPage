<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Resource Search and Filter</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,600;1,600&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Oxygen:wght@300;400;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
        />
        <link
            rel="stylesheet"
            href="https://resourcespage.pages.dev/customColors.css"
        />
        <style>
        .card-sidenav {
            max-width: 70px;
            border-radius: 5px 0 0 5px;
        }

        .card-sidenav a {
            background-color: #55298a;
            color: white !important;
            font-size: 36px;
        }

        .card-sidenav a:hover {
            background-color: #f5ebf3;
            color: #55298a !important;
            overflow: hidden;
        }

        .card-sidenav a:nth-of-type(1) {
            border-radius: 5px 0 0 0;
        }

        .card-sidenav a:nth-of-type(2) {
            border-radius: 0;
        }

        .card-sidenav a:nth-of-type(3) {
            border-radius: 0 0 0 5px;
        }

        .cardImage {
            max-width: 150px;
            height: auto !important;
            @media (width < 768px) {
                position: static;
            }
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            margin: 5px;
            background-color: #e0e0e0;
            border-radius: 20px;
        }

        .close-chip {
            margin-left: 5px;
            cursor: pointer;
        }


        label {
            padding: 2px 8px;
        }
        
        label:active {
            background-color: rgba(89, 49, 150, 0.25);
            border-radius: 3px;
        }
        
        label:hover {
            background-color: rgba(89, 49, 150, 0.25);
            border-radius: 3px;
        }

            .cardImage {
                max-width: 150px;
                height: auto !important;
                @media (width < 768px) {
                    position: static;
                }
            }

            .chip {
                display: inline-flex;
                align-items: center;
                padding: 5px 10px;
                margin: 5px;
                background-color: #e0e0e0;
                border-radius: 20px;
            }

            .close-chip {
                margin-left: 5px;
                cursor: pointer;
            }

            label {
                padding: 2px 8px;
            }

            label:active {
                background-color: rgba(89, 49, 150, 0.25);
                border-radius: 3px;
            }

            label:hover {
                background-color: rgba(89, 49, 150, 0.25);
                border-radius: 3px;
            }

            .results-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }

            .results-count {
                font-size: 1rem;
                color: #666;
            }

            .sort-control {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .sort-control label {
                font-size: 0.9rem;
                font-weight: 400;
                color: #555;
                margin-bottom: 0;
            }

            .sort-control select {
                border-radius: 5px;
                padding: 0.5rem;
                font-size: 0.9rem;
                border: 1px solid #ddd;
            }

            .sort-control select:focus {
                border-color: #007bff;
                box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            }

            #load-more {
                margin-top: 20px;
                text-align: center;
            }

            #load-more button {
                border-radius: 5px;
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="container-fluid">
            <div class="row justify-content-center mt-4">
                <div class="col-12 col-md-8">
                    <div class="input-group">
                        <input
                            type="text"
                            id="search-bar"
                            class="form-control form-control-lg"
                            placeholder="Click Here or CTRL + K to Search"
                        />
                        <button id="search-button" class="btn btn-primary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center mt-2">
                <div class="col-12 col-md-8" id="chips-container"></div>
            </div>

            <div class="row justify-content-center mt-4">
                <div class="col-12 col-md-8">
                    <h2>Filters</h2>
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-4">
                            <h5 class="mb-2 text-secondary">Counties</h5>
                            <div id="counties-filter">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Berks"
                                        id="county-berks"
                                    />
                                    <label class="form-check-label" for="county-berks"
                                        >Berks</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Bucks"
                                        id="county-bucks"
                                    />
                                    <label class="form-check-label" for="county-bucks"
                                        >Bucks</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Chester"
                                        id="county-chester"
                                    />
                                    <label class="form-check-label" for="county-chester"
                                        >Chester</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Delaware"
                                        id="county-delaware"
                                    />
                                    <label class="form-check-label" for="county-delaware"
                                        >Delaware</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Lancaster"
                                        id="county-lancaster"
                                    />
                                    <label class="form-check-label" for="county-lancaster"
                                        >Lancaster</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Montgomery"
                                        id="county-montgomery"
                                    />
                                    <label class="form-check-label" for="county-montgomery"
                                        >Montgomery</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Schuylkill"
                                        id="county-schuylkill"
                                    />
                                    <label class="form-check-label" for="county-schuylkill"
                                        >Schuylkill</label
                                    >
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3 mb-4">
                            <h5 class="mb-2 text-secondary">Populations</h5>
                            <div id="populations-filter">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Men"
                                        id="population-men"
                                    />
                                    <label class="form-check-label" for="population-men"
                                        >Men</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Women"
                                        id="population-women"
                                    />
                                    <label class="form-check-label" for="population-women"
                                        >Women</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Children"
                                        id="population-children"
                                    />
                                    <label class="form-check-label" for="population-children"
                                        >Children</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Adolescents"
                                        id="population-adolescents"
                                    />
                                    <label class="form-check-label" for="population-adolescents"
                                        >Adolescents</label
                                    >
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3 mb-4">
                            <h5 class="mb-2 text-secondary">Resource Types</h5>
                            <div id="resource-types-filter">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Recovery Support"
                                        id="resource-type-recovery"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="resource-type-recovery"
                                        >Recovery Support</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Family Support"
                                        id="resource-type-family"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="resource-type-family"
                                        >Family Support</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Housing"
                                        id="resource-type-housing"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="resource-type-housing"
                                        >Housing</label
                                    >
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="Transportation"
                                        id="resource-type-transportation"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="resource-type-transportation"
                                        >Transportation</label
                                    >
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3 mb-4">
                            <h5 class="mb-2 text-secondary">Categories</h5>
                            <div id="categories-filter"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center mt-4">
                <div class="col-12 col-md-8">
                    <div class="results-header">
                        <h3 class="results-count">Results 1-25 of <span id="total-results">0</span></h3>
                        <div class="sort-control">
                            <label for="sort-by">Sort By:</label>
                            <select id="sort-by">
                                <option value="relevance">Relevance</option>
                                <option value="alphabetical">Alphabetical</option>
                            </select>
                        </div>
                    </div>
                    <div id="results-container" class="row g-4">
                        </div>
                    <div id="load-more" class="mt-4">
                        <button class="btn btn-primary" id="load-more-button">Load More</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
        <script>
            const tsvDataUrl =
                "https://docs.google.com/spreadsheets/d/e/2PACX-1vT6vEL-KJVJHDmWJ9MGJEJMJBjDX7JzM-a-DfIJ_p7nEt4oha1UaeIhMp5dlldvuV8iqsAIDG69E8oI/pub?gid=1459594612&single=true&output=tsv";

            const countyFilter = document.getElementById("counties-filter");
            const populationsFilter = document.getElementById("populations-filter");
            const resourceTypesFilter = document.getElementById("resource-types-filter");
            const categoriesFilter = document.getElementById("categories-filter");
            const searchBar = document.getElementById("search-bar");
            const searchButton = document.getElementById("search-button");
            const resultsContainer = document.getElementById("results-container");
            const chipsContainer = document.getElementById("chips-container");
            const sortBySelect = document.getElementById("sort-by");
            const loadMoreButton = document.getElementById("load-more-button");
            const resultsCountElement = document.querySelector(".results-count");
            const totalResultsElement = document.getElementById("total-results");

            const itemsPerPage = 25;
            let currentPage = 1;
            let allData = [];
            let filteredData = [];
            let activeFilters = {
                search: "",
                counties: [],
                populations: [],
                resourceTypes: [],
                categories: [],
            };
            let fuse;
            let categoryOptions = {
                "Recovery Support": [
                    "Single County Authority",
                    "Center of Excellence",
                    "Regional Recovery Hub",
                    "Recovery Community Organization",
                    "Warm Handoff",
                    "Treatment with RSS",
                ],
                "Family Support": [
                    "Family Counseling",
                    "Family Peer Support",
                    "Family Assistance Program",
                    "Family Education Program",
                    "Family Resources",
                ],
                "Housing": ["Recovery House", "Halfway House", "Housing Assistance"],
                "Transportation": [
                    "Affordable Public Transportation",
                    "Carpool Service",
                    "Medical Assistance Transportation",
                    "Recovery Transportation Services",
                    "Vehicle Purchase Assistance",
                ],
                "All": [
                    "Single County Authority",
                    "Center of Excellence",
                    "Regional Recovery Hub",
                    "Recovery Community Organization",
                    "Warm Handoff",
                    "Treatment with RSS",
                    "Family Counseling",
                    "Family Peer Support",
                    "Family Assistance Program",
                    "Family Education Program",
                    "Family Resources",
                    "Recovery House",
                    "Halfway House",
                    "Housing Assistance",
                    "Affordable Public Transportation",
                    "Carpool Service",
                    "Medical Assistance Transportation",
                    "Recovery Transportation Services",
                    "Vehicle Purchase Assistance",
                    "Government",
                    "Other"
                ],
            };

            /**
             * Parses TSV data and converts it into an array of objects.
             * @param {string} tsv - The TSV data string.
             * @returns {Array<object>} An array of objects representing the data.
             */
            function parseTSV(tsv) {
                const lines = tsv.trim().split("\n");
                const headers = lines[0].split("\t").map((header) => header.replace(/"/g, ""));
                return lines.slice(1).map((line) => {
                    const values = line.split("\t").map((value) => value.replace(/"/g, ""));
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index] ? values[index].trim() : "";
                        return obj;
                    }, {});
                });
            }

            /**
             * Fetches TSV data from a URL, parses it, and initializes the app.
             */
            function fetchData() {
                fetch(tsvDataUrl)
                    .then((response) => response.text())
                    .then((tsvData) => {
                        allData = parseTSV(tsvData);
                        initializeFuse();
                        initializeEventListeners();
                        updateCategoryOptions();
                        filterAndDisplayResults(); // Initial display
                    })
                    .catch((error) => console.error("Error fetching TSV data:", error));
            }

            /**
             * Initializes Fuse.js for searching.
             */
            function initializeFuse() {
                const fuseOptions = {
                    keys: [
                        "LOCATION NAME",
                        "ORGANIZATION",
                        "COUNTY",
                        "RESOURCE TYPE",
                        "CATEGORY",
                        "POPULATIONS",
                        "ADDRESS",
                        "CITY",
                        "STATE",
                        "ZIP CODE",
                    ],
                    includeMatches: true,
                    threshold: 0.3,
                };
                fuse = new Fuse(allData, fuseOptions);
            }

            /**
             * Initializes event listeners for filters, search, and sorting.
             */
            function initializeEventListeners() {
                countyFilter.addEventListener("change", handleFilterChange);
                populationsFilter.addEventListener("change", handleFilterChange);
                resourceTypesFilter.addEventListener("change", handleFilterChange);
                categoriesFilter.addEventListener("change", handleFilterChange);
                searchBar.addEventListener("input", handleSearch);
                searchButton.addEventListener("click", handleSearch);
                sortBySelect.addEventListener("change", handleSort);
                loadMoreButton.addEventListener("click", loadMoreResults);

                // Keyboard shortcut for search bar focus (Ctrl+K)
                document.addEventListener("keydown", (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === "k") {
                        e.preventDefault(); // Prevent browser's default behavior
                        searchBar.focus();
                    }
                });
                searchBar.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        handleSearch();
                        searchBar.value = "";
                    }
                });
            }

            /**
             * Handles changes in filter checkboxes.
             */
            function handleFilterChange() {
                activeFilters.counties = Array.from(
                    countyFilter.querySelectorAll('input[type="checkbox"]:checked')
                ).map((checkbox) => checkbox.value);
                activeFilters.populations = Array.from(
                    populationsFilter.querySelectorAll('input[type="checkbox"]:checked')
                ).map((checkbox) => checkbox.value);
                activeFilters.resourceTypes = Array.from(
                    resourceTypesFilter.querySelectorAll('input[type="checkbox"]:checked')
                ).map((checkbox) => checkbox.value);
                activeFilters.categories = Array.from(
                    categoriesFilter.querySelectorAll('input[type="checkbox"]:checked')
                ).map((checkbox) => checkbox.value);

                updateCategoryOptions();
                filterAndDisplayResults();
            }

            /**
             * Updates the category filter options based on selected resource types.
             */
            function updateCategoryOptions() {
                let selectedResourceTypes = activeFilters.resourceTypes;

                let categories = [];
                if (selectedResourceTypes.length === 0) {
                    categories = categoryOptions["All"];
                } else {
                    selectedResourceTypes.forEach((type) => {
                        const typeCategories = categoryOptions[type] || [];
                        categories = [...new Set([...categories, ...typeCategories])]; //prevent duplicates
                    });
                    categories = [...new Set([...categories, "Government", "Other"])];
                }

                categoriesFilter.innerHTML = ""; // Clear existing options
                categories.forEach((category) => {
                    const div = document.createElement("div");
                    div.className = "form-check";
                    const input = document.createElement("input");
                    input.className = "form-check-input";
                    input.type = "checkbox";
                    input.value = category;
                    input.id = `category-${category.toLowerCase().replace(/ /g, "-")}`; //create id
                    const label = document.createElement("label");
                    label.className = "form-check-label";
                    label.htmlFor = `category-${category.toLowerCase().replace(/ /g, "-")}`;
                    label.textContent = category;
                    div.appendChild(input);
                    div.appendChild(label);
                    categoriesFilter.appendChild(div);

                    //re-add the event listener.
                    input.addEventListener("change", handleFilterChange);
                });
            }

            /**
             * Handles search input changes.
             */
            function handleSearch() {
                activeFilters.search = searchBar.value.trim();
                filterAndDisplayResults();
            }

            /**
             * Applies filters and search to the data, and then displays the results.
             */
            function filterAndDisplayResults() {
                currentPage = 1; // Reset to first page of results
                let results = allData;

                // Apply search if there is a search term
                if (activeFilters.search) {
                    const searchResults = fuse.search(activeFilters.search);
                    results = searchResults.map((result) => result.item);
                    if (searchResults.length > 0) {
                        createChip("Search", activeFilters.search);
                    }
                }

                // Apply category filters
                if (activeFilters.categories.length > 0) {
                    results = results.filter((item) =>
                        activeFilters.categories.includes(item.CATEGORY)
                    );
                }
                // Apply county filters
                if (activeFilters.counties.length > 0) {
                    results = results.filter((item) =>
                        activeFilters.counties.includes(item.COUNTY)
                    );
                }

                // Apply population filters
                if (activeFilters.populations.length > 0) {
                    results = results.filter((item) => {
                        if (!item.POPULATIONS) return false;
                        const populations = item.POPULATIONS.split(",").map((p) => p.trim());
                        return activeFilters.populations.some((pop) => populations.includes(pop));
                    });
                }

                // Apply resource type filters
                if (activeFilters.resourceTypes.length > 0) {
                    results = results.filter((item) =>
                        activeFilters.resourceTypes.includes(item["RESOURCE TYPE"])
                    );
                }
                filteredData = results;
                displayResults(filteredData);
            }

            /**
             * Displays the filtered results, paginated.
             * @param {Array<object>} data - The data to display.
             */
            function displayResults(data) {
                resultsContainer.innerHTML = ""; // Clear previous results
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const currentResults = data.slice(startIndex, endIndex);

                currentResults.forEach((item) => {
                    const cardHTML = generateCardHTML(item);
                    resultsContainer.insertAdjacentHTML("beforeend", cardHTML);
                });
                updateResultsCount(data.length);
                toggleLoadMoreButton(data.length);
            }

            /**
             * Handles "Load More" button clicks.
             */
            function loadMoreResults() {
                currentPage++;
                displayResults(filteredData);
            }

            /**
             * Toggles the visibility of the "Load More" button.
             * @param {number} totalResults - The total number of results.
             */
            function toggleLoadMoreButton(totalResults) {
                if (currentPage * itemsPerPage >= totalResults) {
                    loadMoreButton.style.display = "none";
                } else {
                    loadMoreButton.style.display = "block";
                }
            }

            /**
             * Updates the results count text.
             * @param {number} total - The total number of results.
             */
            function updateResultsCount(total) {
                const start = (currentPage - 1) * itemsPerPage + 1;
                const end = Math.min(currentPage * itemsPerPage, total);
                resultsCountElement.textContent = `Results ${start}-${end} of `;
                totalResultsElement.textContent = total;
            }

            /**
             * Handles sorting of results.
             */
            function handleSort() {
                const sortValue = sortBySelect.value;
                if (sortValue === "relevance") {
                    // Reset to the original order (before any sorting)
                    filteredData = Array.from(filteredData);
                } else if (sortValue === "alphabetical") {
                    // Sort alphabetically by location name
                    filteredData.sort((a, b) =>
                        a["LOCATION NAME"].localeCompare(b["LOCATION NAME"])
                    );
                }
                displayResults(filteredData);
            }

            /**
             * Generates the HTML for a resource card.
             * @param {object} item - The resource data.
             * @returns {string} The HTML for the card.
             */
            function generateCardHTML(item) {
                const website = item.WEBSITE
                    ? `<a class="d-flex align-items-center justify-content-center flex-grow-1 w-100 text-white" href="${item.WEBSITE}" target="_blank" rel="noopener noreferrer"
                  ><i class="bi bi-globe"></i
              ></a>`
                    : "";
                const phoneUrl = item["PHONE URL"]
                    ? `<a class="d-flex align-items-center justify-content-center flex-grow-1 w-100 text-white" href="${item["PHONE URL"]}"
                  ><i class="bi bi-telephone"></i
              ></a>`
                    : "";
                const fullAddress = item["FULL ADDRESS"]
                    ? `<a class="d-flex align-items-center justify-content-center flex-grow-1 w-100 text-white" href="${item["GOOGLE MAPS URL"]}" target="_blank" rel="noopener noreferrer"
                  ><i class="bi bi-geo-alt"></i
              ></a>`
                    : "";
                const image = item.IMAGE
                    ? item.IMAGE
                    : "https://resourcespage.pages.dev/assets/resource-logos/default.png";

                return `
              <div class="col-12">
                  <div class="card shadow-lg text-bg-white br-5-5-5-5 mb-5">
                      <div class="row no-gutters p-0">
                          <div class="card-sidenav col-2 d-flex flex-column justify-content-between align-items-center p-0">
                              ${website}
                              ${phoneUrl}
                              ${fullAddress}
                          </div>
                          <div class="card-body col-10 p-4">
                              <div class="row"> </div>
                              <h3 class="text-secondary" style="font-weight:400;margin-bottom:0;line-height:1.2em;font-size:36px">${item["LOCATION NAME"]}</h3>
                              <h5 style="font-weight:100;margin-top:0;font-size:18px">${item.ORGANIZATION}</h5>
                              <nav aria-label="breadcrumb">
                                  <ol class="breadcrumb">
                                      <li class="breadcrumb-item">
                                          ${generateBadgeHTML("RESOURCE TYPE", item["RESOURCE TYPE"])}
                                      </li>
                                      <li class="breadcrumb-item">
                                          ${generateBadgeHTML("CATEGORY", item.CATEGORY)}
                                      </li>
                                  </ol>
                              </nav>
                              <div class="row d-flex justify-content-end position-relative"><img src="${image}" alt="Logo" style="width:200px; height:auto; align-self: center; position: absolute">
                              </div>
                              <p><strong>Phone:</strong> ${item.PHONE}</p>
                              <p>Address
                                  <br />${item.CITY}, ${item.STATE} ${item["ZIP CODE"]}</p>
                              <div><strong>Populations Served:</strong>
                                  ${generateBadgeHTML("POPULATIONS", item.POPULATIONS)}
                              </div>
                              <div><strong>Counties Served:</strong>
                                  ${generateBadgeHTML("COUNTY", item.COUNTY)}
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;
            }

            /**
             * Generates the HTML for a badge, with a link to filter by the badge's value
             * @param {string} filterType - The type of filter (e.g., "COUNTY", "POPULATIONS").
             * @param {string} value - The value of the badge.
             * @returns {string} The HTML for the badge.
             */
            function generateBadgeHTML(filterType, value) {
                if (!value) return "";

                const values = value.split(",").map((v) => v.trim()); // Handle comma-separated values
                let badgeHTML = "";

                values.forEach((val) => {
                    const filterId = filterType.toLowerCase().replace(/ /g, "-");
                    const uniqueFilterId = `${filterId}-${val.toLowerCase().replace(/ /g, "-")}`;
                    badgeHTML += `<span class="badge bg-primary me-1" id="${uniqueFilterId}" style="cursor: pointer;">${val}</span>`;
                });
                return badgeHTML;
            }

            /**
             * Creates a filter chip and adds it to the chips container.
             * @param {string} filterType - The type of filter.
             * @param {string} value - The value of the filter.
             */
            function createChip(filterType, value) {
                const chip = document.createElement("div");
                chip.className = "chip";
                chip.textContent = `${filterType}: ${value}`;
                const close = document.createElement("span");
                close.className = "close-chip";
                close.innerHTML = "&times;"; // "x" character
                close.addEventListener("click", () => {
                    removeChip(chip, filterType, value);
                });
                chip.appendChild(close);
                chipsContainer.appendChild(chip);
            }

            /**
             * Removes a filter chip and updates the filters.
             * @param {HTMLElement} chip - The chip to remove.
             * @param {string} filterType - The type of filter.
             * @param {string} value - The value of the filter.
             */
            function removeChip(chip, filterType, value) {
                chip.remove();

                // Update the activeFilters object
                if (filterType === "Search") {
                    activeFilters.search = "";
                    searchBar.value = "";
                } else if (
                    filterType === "COUNTY" ||
                    filterType === "POPULATIONS" ||
                    filterType === "RESOURCE TYPE" ||
                    filterType === "CATEGORY"
                ) {
                    const filterArray = activeFilters[filterType.toLowerCase()];
                    const index = filterArray.indexOf(value);
                    if (index > -1) {
                        filterArray.splice(index, 1);
                    }
                    // Uncheck the corresponding checkbox
                    const checkboxId = `${filterType
                        .toLowerCase()
                        .replace(/ /g, "-")}-${value.toLowerCase().replace(/ /g, "-")}`;
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                }
                filterAndDisplayResults();
            }

            // Initialize the app.
            fetchData();
        </script>
    </body>
</html>
