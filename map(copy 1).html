<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Recovery Support Locations</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { width: 100%; height: 500px; }
        .location-links { margin-top: 20px; }
        .location-links button { padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        .map-popup { padding: 10px; }
        .map-popup h3 { margin-top: 0; }
        .custom-marker {
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="location-links">
    <h3>View Location Details:</h3>
    <p id="loading-message">Loading location data...</p>
    </div>

<script>
    const map = new maplibregl.Map({
        style: 'https://tiles.openfreemap.org/styles/liberty',
        center: [-75.347468, 40.104172],
        zoom: 9.5,
        container: 'map',
        attributionControl: false // Disable the default attribution control
    });

    // Add a custom attribution control
    map.addControl(new maplibregl.AttributionControl({
        customAttribution: 'Â© 2025 The Council of Southeast Pennsylvania' // Replace with your desired text
    }), 'bottom-right');

    const locationLinksContainer = document.querySelector('.location-links');
    const loadingMessage = document.getElementById('loading-message');
    let locationsData = [];
    const markers = [];

    fetch('https://resourcesdatabaseproxy.crodican.workers.dev/?limit=999999')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadingMessage.style.display = 'none';

            if (data && Array.isArray(data.list)) {
                locationsData = data.list;
                locationLinksContainer.innerHTML = '<h3>View Location Details:</h3>';

                locationsData.forEach((location, index) => {
                    const popupContent = `
                        <div class="map-popup">
                            <h3>${location["Location Name"]}</h3>
                            <p><strong>Phone:</strong> <a href="tel:${location.Phone}">${location.Phone}</a></p>
                            <p><strong>Address:</strong> ${location["Full Address"]}</p>
                            ${location.Website ? `<p><a href="${location.Website}" target="_blank">Website</a></p>` : ''}
                        </div>
                    `;

                    const popup = new maplibregl.Popup({ offset: 25 })
                        .setHTML(popupContent);

                    const markerElement = document.createElement('div');
                    markerElement.className = 'custom-marker';

                    const marker = new maplibregl.Marker(markerElement)
                        .setLngLat([parseFloat(location.Longitude), parseFloat(location.Latitude)])
                        .setPopup(popup)
                        .addTo(map);

                    markers.push({ marker: marker, index: index });

                    const button = document.createElement('button');
                    button.textContent = location.County + ' County';
                    button.onclick = () => flyToLocationAndOpenPopup(index);
                    locationLinksContainer.appendChild(button);
                });

                if (locationsData.length > 0) {
                    const bounds = new maplibregl.LngLatBounds();
                    locationsData.forEach(location => bounds.extend([parseFloat(location.Longitude), parseFloat(location.Latitude)]));
                    map.fitBounds(bounds, { padding: 50 });
                }
            } else {
                console.error('Error: Fetched data does not contain a valid list of locations:', data);
                locationLinksContainer.innerHTML = '<p>Error: Invalid location data received.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching location data:', error);
            loadingMessage.style.display = 'none';
            locationLinksContainer.innerHTML = `<p>Error loading location data: ${error.message}</p>`;
        });

    function flyToLocationAndOpenPopup(locationIndex) {
        if (!locationsData[locationIndex]) {
            console.error('Location index out of bounds:', locationIndex);
            return;
        }
        const location = locationsData[locationIndex];
        map.flyTo({
            center: [parseFloat(location.Longitude), parseFloat(location.Latitude)],
            zoom: 12,
            essential: true
        });

        markers.forEach(item => {
            if (item.index === locationIndex) {
                item.marker.togglePopup();
            } else {
                item.marker.getPopup().remove();
            }
        });
    }

    markers.forEach(item => {
        item.marker.on('click', () => {
            markers.forEach(otherItem => {
                if (otherItem !== item) {
                    otherItem.marker.getPopup().remove();
                }
            });
        });
    });
</script>

</body>
</html>