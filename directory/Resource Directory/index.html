<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Jitsi Meet Embed (Bootstrap 5.3)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://meet.jit.si/external_api.js"></script>

    <style>
        /* Optional: Make the Jitsi container fill available space */
        #jitsi-container {
            width: 100%;
            height: 70vh; /* 70% of viewport height */
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Style for the event log */
        #event-log {
            max-height: 150px;
            overflow-y: scroll;
            font-size: 0.8rem;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

    <header class="bg-primary text-white p-3 mb-4">
        <div class="container">
            <h1>My Custom Video Portal</h1>
            <p class="mb-0">Powered by Jitsi Meet - Branding Hidden Inside!</p>
        </div>
    </header>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h2 class="mb-3">Jitsi Meeting Embed</h2>
                <div id="jitsi-container">
                    </div>
                <div class="alert alert-info mt-3" id="room-name-info"></div>
            </div>

            <div class="col-lg-4">
                <h3 class="mb-3">API Controls & Events</h3>

                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">Execute Commands</div>
                    <div class="card-body d-grid gap-2">
                        <button class="btn btn-outline-danger" onclick="executeJitsiCommand('toggleAudio')">
                            <i class="bi bi-mic"></i> Toggle Audio Mute
                        </button>
                        <button class="btn btn-outline-secondary" onclick="executeJitsiCommand('toggleTileView')">
                            <i class="bi bi-grid-3x3-gap"></i> Toggle Tile View
                        </button>
                        <button class="btn btn-outline-danger" onclick="executeJitsiCommand('hangup')">
                            <i class="bi bi-telephone-x"></i> End Call (Local Participant)
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-success text-white">Event Log</div>
                    <div class="card-body" id="event-log">
                        Awaiting events...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center text-lg-start mt-4 p-3 border-top">
        <div class="container">
            <p class="mb-0">&copy; 2025 My Company. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        let api = null;
        const JITSI_DOMAIN = 'meet.jit.si';
        const LOG_ELEMENT = document.getElementById('event-log');
        const ROOM_INFO_ELEMENT = document.getElementById('room-name-info');

        /**
         * Utility function to log events to the console and the HTML log.
         * @param {string} message - The message to log.
         * @param {string} type - 'info', 'success', 'danger', 'warning'.
         */
        function logEvent(message, type = 'info') {
            console.log(message);
            const entry = document.createElement('div');
            entry.className = `text-${type} mb-1`;
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            LOG_ELEMENT.prepend(entry); // Add new entry to the top
            // Limit log entries to prevent excessive memory usage
            while (LOG_ELEMENT.children.length > 20) {
                LOG_ELEMENT.removeChild(LOG_ELEMENT.lastChild);
            }
        }

        /**
         * Generates a random unique room name or reads it from the URL.
         * @returns {string} The room name.
         */
        function getRoomName() {
            // 1. Check for room name in URL query parameter (e.g., ?room=MyRoomName)
            const urlParams = new URLSearchParams(window.location.search);
            let roomName = urlParams.get('room');

            if (!roomName) {
                // 2. If not in URL, generate a unique one (UUID-like structure)
                roomName = 'MyCustomRoom-' + Math.random().toString(36).substring(2, 9) + '-' + Date.now().toString().slice(-4);
                logEvent(`Generated unique room: ${roomName}`, 'warning');
                ROOM_INFO_ELEMENT.innerHTML = `**Room Name:** <span class="fw-bold">${roomName}</span> (Generated. You can share this URL to invite others: ${window.location.origin}${window.location.pathname}?room=${roomName})`;
            } else {
                logEvent(`Using room name from URL: ${roomName}`, 'success');
                ROOM_INFO_ELEMENT.innerHTML = `**Room Name:** <span class="fw-bold">${roomName}</span> (Read from URL parameter.)`;
            }

            return roomName;
        }

        /**
         * Initializes and embeds the Jitsi Meet conference.
         */
        function startJitsi() {
            const roomName = getRoomName();

            const options = {
                roomName: roomName,
                parentNode: document.querySelector('#jitsi-container'),
                width: '100%',
                height: '100%',
                
                // ðŸ“§ Passing userInfo (display name, email)
                userInfo: {
                    displayName: 'Custom User (API)',
                    email: 'custom.user@example.com'
                },

                // âš™ï¸ configOverwrite: Used for deeper internal configuration
                configOverwrite: {
                    // Disable deep links to native app on mobile (keeps users in the browser)
                    disableDeepLinking: true,
                    // Additional configuration can go here
                },

                // ðŸŽ¨ interfaceConfigOverwrite: Used for UI/Branding customization
                interfaceConfigOverwrite: {
                    // ðŸ—‘ï¸ Hide Jitsi branding/watermark
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_POWERED_BY: false,
                    
                    // ðŸ”§ Customizing toolbar buttons
                    // List of buttons to show on the toolbar. 'microphone' and 'camera' are required.
                    TOOLBAR_BUTTONS: [
                        'microphone',
                        'camera',
                        'closedcaptions', // Keep a few
                        'desktop',
                        'fodeviceselection',
                        'fullscreen',
                        'hangup',
                        'tileview',
                        'settings'
                        // You can remove buttons by omitting them, e.g., 'chat', 'raisehand', etc.
                    ],
                }
            };

            // Instantiate the Jitsi Meet API
            api = new JitsiMeetExternalAPI(JITSI_DOMAIN, options);

            // ðŸ‘‚ Listening to key events
            api.addListener('participantJoined', (participant) => {
                logEvent(`Participant **${participant.displayName || participant.id}** joined.`, 'success');
            });

            api.addListener('participantLeft', (participant) => {
                logEvent(`Participant **${participant.displayName || participant.id}** left.`, 'danger');
            });

            api.addListener('audioMuteStatusChanged', (status) => {
                logEvent(`Local audio mute status changed to: **${status.muted ? 'Muted' : 'Unmuted'}**`, 'info');
            });

            api.addListener('videoConferenceJoined', (event) => {
                logEvent(`You have joined the conference: **${event.roomName}**`, 'info');
            });
            
            api.addListener('readyToClose', () => {
                logEvent('Conference window is ready to close. Removing the iframe.', 'danger');
                // Clean up the API instance and DOM element after a successful call end
                api.dispose();
                document.querySelector('#jitsi-container').innerHTML = '<p class="p-3">The Jitsi Meet session has ended.</p>';
                api = null;
            });

            logEvent('Jitsi API loaded and listeners attached.', 'info');
        }

        /**
         * Executes a command on the Jitsi Meet API instance.
         * @param {string} command - The command to execute (e.g., 'toggleAudio', 'toggleTileView', 'hangup').
         */
        function executeJitsiCommand(command) {
            if (api) {
                switch (command) {
                    case 'toggleAudio':
                        api.executeCommand('toggleAudio');
                        logEvent('Executed command: **Toggle Audio**', 'warning');
                        break;
                    case 'toggleTileView':
                        api.executeCommand('toggleTileView');
                        logEvent('Executed command: **Toggle Tile View**', 'warning');
                        break;
                    case 'hangup':
                        api.executeCommand('hangup');
                        logEvent('Executed command: **End Call (Hangup)**', 'danger');
                        break;
                    default:
                        logEvent(`Unknown command: ${command}`, 'danger');
                }
            } else {
                logEvent('Jitsi API is not initialized.', 'danger');
            }
        }

        // Start the Jitsi conference when the page loads
        window.onload = startJitsi;
    </script>

</body>
</html>