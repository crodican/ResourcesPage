<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resources Table - The Council of Southeast PA</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Lora&family=Oxygen:wght@300;400;700&display=swap"
      rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <!-- Bootstrap 5.3.3 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
    <!-- Bootstrap 5.3.3 Grid CSS -->
    <link rel="stylesheet" href="bs-grid.css" />
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- Elevation Bootstrap CSS -->
    <link rel="stylesheet" href="https://resourcespage.pages.dev/elevation-bootstrap.css">
    <!-- Custom Colors CSS -->
    <link rel="stylesheet" href="https://resourcespage.pages.dev/customColors.css">
    <style>
      body {
        font-family: "Oxygen", sans-serif;
        background-color: #f8f9fa;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: "Lora", serif;
        font-weight: 700;
        color: #55298a;
      }

      .header-section {
        background: linear-gradient(135deg, #55298a 0%, #20cb98 100%);
        color: white;
        padding: 2rem 0;
      }

      .header-section h1 {
        color: white;
      }

      .search-controls {
        border-radius: 10px;
        padding: 1.5rem;
        margin: -10rem 0 5rem 0;
        position: relative;
        z-index: 10;
      }

      .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .table {
        margin-bottom: 0;
      }

      .table thead th {
        background-color: #55298a;
        color: white;
        border: none;
        font-weight: 600;
        padding: 0.75rem 0.5rem;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
        position: relative;
        vertical-align: middle;
        min-width: 80px;
        border-right: 1px solid rgba(255, 255, 255, 0.2);
      }

      .table thead th:hover {
        background-color: #6d3ba0;
      }

      .table thead th.sortable::after {
        content: " ↕";
        opacity: 0.5;
        float: right;
        margin-left: 0.5rem;
      }

      .table thead th.sort-asc::after {
        content: " ↑";
        opacity: 1;
      }

      .table thead th.sort-desc::after {
        content: " ↓";
        opacity: 1;
      }

      .resize-handle {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 8px;
        cursor: col-resize;
        z-index: 20;
        background: transparent;
        border-right: 2px solid transparent;
      }

      .resize-handle:hover {
        background: rgba(255, 255, 255, 0.2);
        border-right: 2px solid rgba(255, 255, 255, 0.5);
      }

      .table tbody tr {
        transition: background-color 0.2s;
        height: 30px;
      }

      .table tbody td {
        height: 30px;
        padding: 0.25rem 0.5rem;
        vertical-align: middle;
        line-height: 1.2;
        font-size: 0.875rem;
      }

      .table tbody tr:hover {
        background-color: #f8f9fa;
      }

      /* Dropdown Filter Styles */
      .filter-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .filter-dropdown.show {
        display: block;
      }

      .filter-option {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .filter-option:hover {
        background-color: #f8f9fa;
      }

      .filter-option:last-child {
        border-bottom: none;
      }

      .filter-option input[type="checkbox"] {
        margin: 0;
      }

      .filter-option label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-size: 0.875rem;
        color: black;
      }

      .filter-header {
        position: relative;
      }

      .filter-indicator {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 8px;
        height: 8px;
        background-color: #20cb98;
        border-radius: 50%;
        display: none;
      }

      .filter-indicator.active {
        display: block;
      }

      .badge {
        margin: 0.125rem;
        font-size: 0.7em;
        padding: 0.35rem 0.5rem;
      }

      .badge-county {
        background-color: #f5ebf3;
        color: black;
      }

      .badge-resource-type {
        background-color: #f5ebf3;
        color: black;
      }

      .badge-category {
        background-color: #f5ebf3;
        color: black;
      }

      .badge-population {
        background-color: #f5ebf3;
        color: black;
      }

      .btn-primary {
        background-color: #55298a;
        border-color: #55298a;
        color: #fff;
      }

      .btn-primary:hover {
        background-color: #f5ebf3;
        border-color: #f5ebf3;
        color: #55298a;
      }

      .input-group {
        background-color: ghostwhite;
      }
      .input-group:focus {
        border-color: #55298a;
        box-shadow: 0 0 0 0.2rem rgba(85, 41, 138, 0.25);
      }

      .form-control:focus {
        background-color: inherit;
        /* Inherit the background from the parent */
        color: whitesmoke;
        /* Inherit the font color from the parent */
        border-color: none;
        /* Inherit the border color from the parent */
        box-shadow: none;
        /* Remove the default box-shadow */
        font-weight: 700;
      }

      .form-control::placeholder {
        color: #685e92;
        font-weight: 700;
      }
      .form-select:focus {
        border-color: #55298a;
        box-shadow: 0 0 0 0.2rem rgba(85, 41, 138, 0.25);
      }
      #searchbar:focus-within .btn {
        background-color: #55298a !important;
        /* Primary blue background for button */
        color: #ffffff;
        /* White text for button */
      }

      #searchbar:focus-within .kbd-wrapper {
        display: none;
      }

      #searchbar:focus-within span {
        color: transparent;
      }
      #searchbar:focus-within {
        background-color: lightsteelblue;
        /* Light blue background for the entire group */
        color: white;
        box-shadow: 0 0 0 0.25rem ghostwhite;
        /* Bootstrap-like focus shadow */
      }

      #searchbar .form-control:focus {
        background-color: inherit;
        /* Inherit the background from the parent */
        color: whitesmoke;
        /* Inherit the font color from the parent */
        border-color: none;
        /* Inherit the border color from the parent */
        box-shadow: none;
        /* Remove the default box-shadow */
        font-weight: 700;
      }

      .loading-spinner {
        display: none;
        justify-content: center;
        align-items: center;
        padding: 3rem;
      }

      .spinner-border {
        color: #55298a;
      }

      .results-info {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 1rem;
      }

      .pagination {
        --bs-pagination-active-bg: #55298a;
        --bs-pagination-active-border-color: #55298a;
      }

      .btn-link {
        color: #55298a;
        text-decoration: none;
      }

      .btn-link:hover {
        color: #f5ebf3;
      }

      .filter-chip {
        background-color: #e9ecef;
        color: #495057;
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        margin: 0.125rem;
        font-size: 0.875em;
        display: inline-block;
      }

      .filter-chip .btn-close {
        font-size: 0.75em;
        margin-left: 0.5rem;
      }

      /* New Filter Controls Styles */
      .filter-count-badge {
        position: absolute;
        top: -5px;
        right: 8px;
        background-color: #55298a;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .dropdown-menu {
        max-height: 300px;
        overflow-y: auto;
      }

      .dropdown-item-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
      }

      .dropdown-item-check:hover {
        background-color: #f8f9fa;
      }

      .dropdown-item-check input[type="checkbox"] {
        margin: 0;
        transform: scale(1.1);
      }

      .dropdown-item-check label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-size: 0.875rem;
        user-select: none;
      }

      .dropdown-toggle {
        text-align: left;
      }

      .dropdown-toggle::after {
        float: right;
        margin-top: 0.5rem;
      }

      .location-image {
        height: 25px;
        width: auto;
        margin-right: 0.5rem;
        border-radius: 3px;
      }

      .location-name-cell {
        display: flex;
        align-items: center;
      }

      /* Map Styles */
      .map-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
      }

      #map {
        @media (width < 576px) {
          height: 400px;
          width: 100%;
        }
        @media (width > 575px) {
          height: 100vw;
          width: 100%;
        }
      }

      .map-popup-container {
        font-family: "Oxygen", sans-serif;
      }

      .map-popup-container h3 {
        color: #55298a !important;
        font-size: 1rem;
        margin-bottom: 0.25rem;
      }

      .map-popup-container h5 {
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }

      .map-popup-container p {
        font-size: 0.75rem;
      }

      .map-popup-container a {
        font-size: 0.75rem;
      }

      .maplibregl-ctrl,
      .maplibregl-ctrl button,
      .maplibregl-ctrl-compass,
      .maplibregl-marker {
        cursor: pointer;
      }

      /* View Toggle Styles */
      .view-toggle {
        display: flex;
        border: 1px solid #55298a;
        border-radius: 6px;
        overflow: hidden;
      }

      .view-toggle-btn {
        padding: 0.5rem 1rem;
        background: white;
        color: #55298a;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .view-toggle-btn:hover {
        background-color: #f8f9fa;
      }

      .view-toggle-btn.active {
        background-color: #55298a;
        color: white;
      }

      .view-toggle-btn:not(:last-child) {
        border-right: 1px solid #55298a;
      }

      /* Card View Styles */
      .resourceCard {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .resourceCard:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .resourceCard[data-longitude]:hover .card-body::after {
        content: "💡 Click map icon to view location";
        position: absolute;
        bottom: 10px;
        left: 20px;
        background: rgba(85, 41, 138, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        pointer-events: none;
        z-index: 10;
      }

      .card-body {
        position: relative;
      }

      .card-sidenav {
        background: #55298a;
        border-radius: 10px 0 0 10px;
        min-height: 200px;
        max-width: 65px;
      }

      .sidenav-button {
        color: white;
        text-decoration: none;
        transition: background-color 0.2s;
        border-radius: 0;
      }

      .card-sidenav a {
        color: white;
        text-decoration: none;
        transition: background-color 0.2s;
        border-radius: 0;
        font-size: 0.9rem;
        padding: 0.5rem;
      }

      .card-sidenav > button {
        color: white;
        text-decoration: none;
        transition: background-color 0.2s;
        border-radius: 0;
      }

      .card-sidenav a:hover {
        background-color: #f5ebf3;
        color: #55298a;
      }

      .card-sidenav a:first-child {
        border-radius: 10px 0 0 0;
      }

      .card-sidenav a:last-child {
        border-radius: 0 0 0 10px;
      }

      .map-fly-btn {
        background: transparent;
        color: white;
        text-decoration: none;
        transition: background-color 0.2s;
        border-radius: 0;
        cursor: pointer;
      }

      .map-fly-btn:hover:not(:disabled) {
        background-color: #f5ebf3;
        color: #55298a;
      }

      .map-fly-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .map-fly-btn:last-child {
        border-radius: 0 0 0 10px;
      }

      .card-sidenav > i {
        font-size: 48px;
      }

      .table-row-clickable {
        position: relative;
      }

      .table-row-clickable:hover {
        cursor: pointer;
      }

      .table-row-clickable[data-longitude]:hover::after {
        content: "Click to view on map";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(85, 41, 138, 0.9);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75rem;
        pointer-events: none;
        z-index: 10;
      }

      .cardImage {
        max-width: 80px;
        max-height: 60px;
        border-radius: 4px;
        object-fit: contain;
      }

      .bg-pink {
        background-color: #f5ebf3 !important;
      }

      .card-body h3 {
        color: #55298a;
        margin-bottom: 0.5rem;
      }

      .card-body h5 {
        color: #6c757d;
        margin-bottom: 1rem;
      }

      .card-body h6 {
        color: #55298a;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        margin-top: 1rem;
      }

      .card-body p {
        color: #6c757d;
        margin-bottom: 1rem;
        line-height: 1.4;
      }

      .card-badge {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        margin: 0.2rem 0.2rem 0.2rem 0;
        background-color: #f5ebf3;
        color: #333;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        transition: background-color 0.2s;
        cursor: pointer;
      }

      .card-badge:hover {
        background-color: #e9d5e4;
      }

      @media (max-width: 768px) {
        .table-responsive {
          font-size: 0.75rem;
        }

        .search-controls {
          margin: -0.5rem 0 1rem 0;
          padding: 1rem;
        }

        .table tbody td {
          font-size: 0.75rem;
          padding: 0.2rem 0.3rem;
        }

        .resourceCard .card-sidenav {
          min-height: 120px;
        }

        /* Stack filter controls vertically on mobile */
        .search-controls .row.g-3 .col-md-3 {
          margin-bottom: 1rem;
        }

        .filter-count-badge {
          right: 5px;
          top: -3px;
          width: 16px;
          height: 16px;
          font-size: 0.6rem;
        }
      }

      @media (width < 576px) {
        .hero-section {
          background-image: url("assets/resourcemap-3.png");
          height: 500px;
          background-position-x: right;
          background-position-y: bottom;
          background-size: cover;
          background-repeat: no-repeat;
          color: #ffffff !important;
        }
        .hero-section h1,
        .hero-section h2,
        .hero-section h3,
        .hero-section h4,
        .hero-section h5,
        .hero-section h6 {
          color: #ffffff !important;
        }
        .kbd-wrapper {
          display: none;
        }
      }
      /* Small */

      @media (width > 575px) {
        .hero-section {
          background-image: url("assets/resourcemap-3.png");
          height: 600px;
          background-position-x: right;
          background-position-y: bottom;
          background-size: cover;
          background-repeat: no-repeat;
          color: #ffffff !important;
        }
        .hero-section h1,
        .hero-section h2,
        .hero-section h3,
        .hero-section h4,
        .hero-section h5,
        .hero-section h6 {
          color: #ffffff !important;
        }
        .kbd-wrapper {
          display: flex;
          justify-content: center;
          align-items: center;
        }
      }
      /* Extra Medium and Up */

      @media (width > 767px) {
        .hero-section {
          background-image: url("https://www.councilsepa.org/wp-content/uploads/2025/05/resourcemap-4-scaled.png");
          height: 600px;
          background-position-x: right;
          background-position-y: bottom;
          background-size: cover;
          background-repeat: no-repeat;
          color: #ffffff !important;
        }
        .hero-section h1,
        .hero-section h2,
        .hero-section h3,
        .hero-section h4,
        .hero-section h5,
        .hero-section h6 {
          color: #ffffff !important;
        }
      }
      kbd {
        padding: 0.1em 0.575em;
        font-size: 0.75em;
        font-weight: 700;
        background-color: rgba(0, 0, 0, 0.35) !important;
        color: white !important;
        border-radius: 0.25rem;
      }
      /* Mobile Filter Controls */
      @media (max-width: 575px) {
        #filter-controls-container {
          display: none;
        }

        #filter-controls-container.show {
          display: block;
        }
      }

      #county-cards .card {
        overflow: hidden;
        /* Ensures the zoomed background image doesn't overflow the card */
        transition: all 0.4s cubic-bezier(1, 0.57, 0.34, -0.05);
        /* Smooth transition for background image zoom */
        background-size: 100%;
        /* Maintain the original background-size if not already set inline */
        background-position: center center;
        filter: brightness(1) saturate(0.5);
        text-shadow: 2.5px 2.5px 10px black;
        text-transform: uppercase;
      }

      #county-cards .card:hover {
        background-size: 110%;
        /* Zooms in the background image */
        filter: brightness(1.25) saturate(1.25);
      }

      #county-cards h3 {
        filter: brightness(1.25);
        color: white;
      }
      
      #county-cards a {
        text-decoration: none;
      }

      #results {
        display: none;
      }

      /* Show results section when .show class is added */
      #results.show {
        display: block;
      }

      /* Smooth transition for results section appearance */
      #results {
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
      }

      #results.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <!-- Header Section -->
    <header class="header">
        <div class="header__section bg-white"> <span class="header__section--fixed-bg"></span>
            <div class="header__container container">
                <nav class="header__nav navbar navbar-expand-xl">
                    <div class="header__navbar">
                        <a href="https://www.councilsepa.org/" rel="home" class="header__logo navbar-brand d-flex">
                            <figure class="media"><img alt="" decoding="async" loading="lazy" src="https://www.councilsepa.org/wp-content/uploads/2024/03/logo-sticky.svg" width="123" height="61"></figure>
                            <figure class="media-sticky"><img alt="" decoding="async" loading="lazy" src="https://www.councilsepa.org/wp-content/uploads/2024/03/logo-sticky.svg" width="123" height="61"></figure>
                            <figure class="media-mobile"><img alt="" decoding="async" loading="lazy" src="https://www.councilsepa.org/wp-content/uploads/2024/03/logo-mobile.svg" width="123" height="61"></figure> <span class="visually-hidden">The Council of Southeast PA, Inc.</span> </a>
                        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#NavDropdown" aria-controls="NavDropdown" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> <span class="visually-hidden">Menu</span> </button>
                    </div>
                    <div class="header__bottom-menu">
                        <div class="collapse navbar-collapse" id="NavDropdown">
                            <div class="wrapper-collapse">
                                <ul id="menu-main-menu" class="nav navbar-nav menu" aria-label="Menu">
                                    <li id="menu-item-124894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children dropdown nav-item nav-item-124894"><a href="https://www.councilsepa.org/about-us/" class="nav-link  dropdown-toggle">About Us</a>
                                        <button class="dropdown-toggle dropdown-btn"><span class="fas fa-chevron-down"></span></button>
                                        <ul class="dropdown-menu  depth_0">
                                            <li id="menu-item-124895" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124895"><a href="https://www.councilsepa.org/mission-history/" class="dropdown-item ">Mission &amp; History</a></li>
                                            <li id="menu-item-124896" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124896"><a href="https://www.councilsepa.org/impact/" class="dropdown-item ">Impact</a></li>
                                            <li id="menu-item-124897" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124897"><a href="https://www.councilsepa.org/our-team/" class="dropdown-item ">Our Team</a></li>
                                            <li id="menu-item-124898" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124898"><a href="https://www.councilsepa.org/our-locations/" class="dropdown-item ">Our Locations</a></li>
                                            <li id="menu-item-124899" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124899"><a href="https://www.councilsepa.org/careers/" class="dropdown-item ">Careers</a></li>
                                        </ul>
                                    </li>
                                    <li id="menu-item-124900" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children dropdown nav-item nav-item-124900"><a href="https://www.councilsepa.org/services/" class="nav-link  dropdown-toggle">Services</a>
                                        <button class="dropdown-toggle dropdown-btn"><span class="fas fa-chevron-down"></span></button>
                                        <ul class="dropdown-menu  depth_0">
                                            <li id="menu-item-124901" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124901"><a href="https://www.councilsepa.org/prevention-training-and-education/" class="dropdown-item ">Prevention, Training and Education</a></li>
                                            <li id="menu-item-124902" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124902"><a href="https://www.councilsepa.org/intervention/" class="dropdown-item ">Intervention and Treatment Services</a></li>
                                            <li id="menu-item-124903" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124903"><a href="https://www.councilsepa.org/pro-act-recovery-support-services/" class="dropdown-item ">PRO-ACT Recovery Support Services</a></li>
                                            <li id="menu-item-124905" class="menu-item menu-item-type-taxonomy menu-item-object-tribe_events_cat nav-item nav-item-124905"><a href="https://www.councilsepa.org/events/category/training-calendar/" class="dropdown-item ">Training Calendar</a></li>
                                        </ul>
                                    </li>
                                    <li id="menu-item-124904" class="menu-item menu-item-type-post_type menu-item-object-page current-page-ancestor current-menu-ancestor current-menu-parent current-page-parent current_page_parent current_page_ancestor menu-item-has-children dropdown nav-item nav-item-124904"><a href="https://www.councilsepa.org/hubs/" class="nav-link active dropdown-toggle">Regional Recovery Hubs</a>
                                        <button class="dropdown-toggle dropdown-btn"><span class="fas fa-chevron-down"></span></button>
                                        <ul class="dropdown-menu  depth_0">
                                            <li id="menu-item-129246" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-129246"><a href="https://www.councilsepa.org/hubs/certifications/" class="dropdown-item ">Certifications</a></li>
                                            <li id="menu-item-129245" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-127730 current_page_item nav-item nav-item-129245"><a href="https://www.councilsepa.org/hubs/ta/" class="dropdown-item">Training &amp; Technical Assistance</a></li>
                                            <li id="menu-item-129244" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-129244"><a href="https://www.councilsepa.org/hubs/resources/" class="dropdown-item active">Resources</a></li>
                                            <li id="menu-item-129249" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-129249"><a href="https://www.councilsepa.org/hubs/family/" class="dropdown-item ">Families</a></li>
                                        </ul>
                                    </li>
                                    <li id="menu-item-124906" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children dropdown nav-item nav-item-124906"><a href="https://www.councilsepa.org/get-involved/" class="nav-link  dropdown-toggle">Get Involved</a>
                                        <button class="dropdown-toggle dropdown-btn"><span class="fas fa-chevron-down"></span></button>
                                        <ul class="dropdown-menu  depth_0">
                                            <li id="menu-item-124907" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124907"><a href="https://www.councilsepa.org/ways-to-give/" class="dropdown-item ">Ways to Give</a></li>
                                            <li id="menu-item-124908" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124908"><a href="https://www.councilsepa.org/volunteer/" class="dropdown-item ">Volunteer</a></li>
                                            <li id="menu-item-124909" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124909"><a href="https://www.councilsepa.org/partner/" class="dropdown-item ">Partner</a></li>
                                            <li id="menu-item-124922" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124922"><a href="https://www.councilsepa.org/events-page/" class="dropdown-item ">Events</a></li>
                                        </ul>
                                    </li>
                                    <li id="menu-item-124911" class="menu-item menu-item-type-custom menu-item-object-custom nav-item nav-item-124911"><a href="https://www.councilsepa.org/category/news-insights/" class="nav-link ">News &amp; Insights</a></li>
                                    <li id="menu-item-124910" class="menu-item menu-item-type-post_type menu-item-object-page nav-item nav-item-124910"><a href="https://www.councilsepa.org/contact-us/" class="nav-link ">Contact Us</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>
    <section id="hero" class="hero-section py-5 w-100 d-flex">
      <div class="container d-flex justify-content-end">
        <div class="row d-flex justify-content-center align-items-center">
          <div class="banner-col col-12">
            <div class="banner-container">
              <p>
                <a href="https://councilsepa.org/hubs" style="text-decoration: none"></a>
              </p>
              <a class="h6 text-white" href="javascript:window.location.reload()" style="text-decoration: none"> ←Back </a>
              <br />
              <br />
              <p></p>
              <h1>Resources</h1>
              <h5>
                Find essential resources including Recovery Support, Family Support, Housing, and Transportation, plus
                links to additional support.
              </h5>
            </div>
            <div id="searchbar" class="input-group rounded-2">
              <input
                type="text"
                class="form-control border-0 bg-transparent"
                id="search-input"
                placeholder="Search by name, organization, location..." />
              <div class="kbd-wrapper bg-transparent border-0 px-2">
                <kbd>CTRL</kbd><span class="text-black px-1">+</span><kbd>K</kbd>
              </div>
              <button class="btn btn-primary px-4" type="button" id="search-btn"><i class="bi bi-search"></i></button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section id="countySearch" class="py-5">
      <div class="container mb-5">
        <div class="row mb-5">
          <div class="col-md-8">
            <h2>Search by County</h2>
          </div>
          <div class="col-md-4 d-md-flex align-items-center justify-content-end">
            <a id="allCounties" class="text-muted text-sm" href="#">
              See all Counties<i class="bi bi-chevron-double-right ms-2"></i
            ></a>
          </div>
        </div>
        <div id="county-cards">
          <div class="grid" style="row-gap: 3">
            <a href="#" data-county="Philadelphia" class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-8" style="height: 100px">
          <div class="card rounded-4 shadow-lg border-0 w-100 border-0" style="background-position: cover; background-image: url(assets/counties/philadelphia.jpg)">
              <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Philadelphia</h3> </div>
          </div>
            </a>
            <a
              href="#"
              data-county="Berks"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-4"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-position: cover; background-image: url(assets/counties/reading2.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Berks</h3>
                </div>
              </div>
            </a>
            <a
              href="#"
              data-county="Bucks"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-6"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-size: : cover; background-image: url(assets/counties/doylestown.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Bucks</h3>
                </div>
              </div>
            </a>
            <a
              href="#"
              data-county="Chester"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-6"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-size: cover; background-image: url(assets/counties/phoenixville.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Chester</h3>
                </div>
              </div>
            </a>
            <a
              href="#"
              data-county="Delaware"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-4"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-size: cover; background-image: url(assets/counties/delco-media.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Delaware</h3>
                </div>
              </div>
            </a>
            <a
              href="#"
              data-county="Lancaster"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-8"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-position: cover; background-image: url(assets/counties/lancaster.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Lancaster</h3>
                </div>
              </div>
            </a>
            <a
              href="#"
              data-county="Montgomery"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-8"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-size: cover; background-image: url(assets/counties/pottstown.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Montgomery</h3>
                </div>
              </div>
            </a>
            <a
              href="#"
              data-county="Schuylkill"
              class="county-card d-flex align-items-lg-stretch mb-4 g-col-12 g-col-sm-12 g-col-md-4"
              style="height: 100px">
              <div
                class="card rounded-4 shadow-lg border-0 w-100 border-0"
                style="background-size: cover; background-image: url(assets/counties/schuylkill.jpg)">
                <div class="d-flex align-items-center h-100 text-white justify-content-center py-6 py-lg-7">
                  <h3>Schuylkill</h3>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>
    <section id="results">
      <div class="container">
        <!-- Search Controls -->
        <div class="search-controls bg-light shadow-lg">
          <div class="row g-3 align-items-end">
            <!-- View Toggle -->
            <div class="col-md-3">
              <label class="form-label">View</label>
              <div class="view-toggle shadow">
                <button class="view-toggle-btn w-50" id="table-view-btn" data-view="table">
                  <i class="bi bi-table"></i>
                  Table
                </button>
                <button class="view-toggle-btn active w-50" id="card-view-btn" data-view="cards">
                  <i class="bi bi-grid10x3-gap"></i>
                  Cards
                </button>
              </div>
            </div>

            <!-- Records Per Page -->
            <div class="col-md-3">
              <label for="per-page-select" class="form-label">Show</label>
              <select class="form-select" id="per-page-select">
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
                <option value="200">200 per page</option>
              </select>
            </div>
          </div>

          <div class="row g-3 align-items-end mt-2 d-block d-sm-none">
            <div class="col-12">
              <button class="btn btn-outline-primary w-100" id="mobile-filter-toggle-btn">
                <i class="bi bi-funnel me-1"></i>Filters
              </button>
            </div>
          </div>

          <div id="filter-controls-container">
            <!-- Filter Controls Row -->
            <div class="row g-3 align-items-end mt-2">
              <!-- County Filter -->
              <div class="col-md-3 col-sm-6 col-12">
                <label class="form-label">County</label>
                <div class="dropdown">
                  <button
                    class="btn btn-outline-secondary dropdown-toggle w-100 position-relative"
                    type="button"
                    id="county-filter-btn"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                    County
                    <span class="filter-count-badge" id="county-count-badge" style="display: none"></span>
                  </button>
                  <ul class="dropdown-menu w-100" id="county-dropdown-menu">
                    <!-- Options will be populated here -->
                  </ul>
                </div>
              </div>

              <!-- Resource Type Filter -->
              <div class="col-md-3 col-sm-6 col-12">
                <label class="form-label">Resource Type</label>
                <div class="dropdown">
                  <button
                    class="btn btn-outline-secondary dropdown-toggle w-100 position-relative"
                    type="button"
                    id="resource-type-filter-btn"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Resource Type
                    <span class="filter-count-badge" id="resource-type-count-badge" style="display: none"></span>
                  </button>
                  <ul class="dropdown-menu w-100" id="resource-type-dropdown-menu">
                    <!-- Options will be populated here -->
                  </ul>
                </div>
              </div>

              <!-- Category Filter -->
              <div class="col-md-3 col-sm-6 col-12">
                <label class="form-label">Category</label>
                <div class="dropdown">
                  <button
                    class="btn btn-outline-secondary dropdown-toggle w-100 position-relative"
                    type="button"
                    id="category-filter-btn"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Category
                    <span class="filter-count-badge" id="category-count-badge" style="display: none"></span>
                  </button>
                  <ul class="dropdown-menu w-100" id="category-dropdown-menu">
                    <!-- Options will be populated here -->
                  </ul>
                </div>
              </div>

              <!-- Populations Filter -->
              <div class="col-md-3 col-sm-6 col-12">
                <label class="form-label">Populations</label>
                <div class="dropdown">
                  <button
                    class="btn btn-outline-secondary dropdown-toggle w-100 position-relative"
                    type="button"
                    id="populations-filter-btn"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Populations
                    <span class="filter-count-badge" id="populations-count-badge" style="display: none"></span>
                  </button>
                  <ul class="dropdown-menu w-100" id="populations-dropdown-menu">
                    <!-- Options will be populated here -->
                  </ul>
                </div>
              </div>
            </div>

            <div class="row g-3 align-items-end mt-2">
              <!-- Clear Filters -->
              <div class="col-md-6">
                <button class="btn btn-outline-secondary w-100" id="clear-filters-btn">
                  <i class="bi bi-x-circle me-1"></i>Clear Filters
                </button>
              </div>
            </div>
          </div>
          <!-- Active Filters Display -->
          <div id="active-filters" class="mt-3" style="display: none">
            <small class="text-muted">Active filters:</small>
            <div id="filter-chips" class="mt-1"></div>
          </div>
        </div>
      </div>
      <!-- Main Content -->
      <div class="container-fluid">
        <div class="row mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="results-info" id="results-info">Loading...</div>
            <div>
              <button class="btn btn-outline-primary btn-sm" id="export-btn" disabled>
                <i class="bi bi-download me-1"></i>Export CSV
              </button>
            </div>
          </div>
        </div>
        <div class="row g-4 flex-column flex-sm-row">
          <div class="col-sm-7 col-lg-8 order-2 order-sm-1 m-0 px-4">
            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loading-spinner">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>

            <!-- Table Container -->
            <div class="table-container" id="table-container" style="display: none">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="resources-table">
                  <thead>
                    <tr>
                      <th class="sortable filter-header" data-column="Location Name">
                        Location Name
                        <div class="filter-indicator" id="location-filter-indicator"></div>
                        <div class="filter-dropdown" id="location-filter-dropdown"></div>
                      </th>
                      <th class="sortable" data-column="Organization">Organization</th>
                      <th class="filter-header" data-column="County">
                        County
                        <div class="filter-indicator" id="county-filter-indicator"></div>
                        <div class="filter-dropdown" id="county-filter-dropdown"></div>
                      </th>
                      <th class="filter-header" data-column="Resource Type">
                        Resource Type
                        <div class="filter-indicator" id="resource-type-filter-indicator"></div>
                        <div class="filter-dropdown" id="resource-type-filter-dropdown"></div>
                      </th>
                      <th class="filter-header" data-column="Category">
                        Category
                        <div class="filter-indicator" id="category-filter-indicator"></div>
                        <div class="filter-dropdown" id="category-filter-dropdown"></div>
                      </th>
                      <th class="filter-header" data-column="Populations Served">
                        Populations
                        <div class="filter-indicator" id="populations-filter-indicator"></div>
                        <div class="filter-dropdown" id="populations-filter-dropdown"></div>
                      </th>
                      <th data-column="Phone">Phone</th>
                      <th data-column="Website">Website</th>
                      <th data-column="Address">Address</th>
                      <th data-column="City">City</th>
                      <th data-column="State">State</th>
                      <th data-column="Zip Code">Zip</th>
                    </tr>
                  </thead>
                  <tbody id="table-body">
                    <!-- Table rows will be inserted here -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Cards Container -->
            <div class="cards-container" id="cards-container" style="display: none">
              <!-- Cards will be inserted here -->
            </div>

            <!-- Pagination -->
            <nav aria-label="Resources pagination" class="mt-4">
              <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination buttons will be inserted here -->
              </ul>
            </nav>
          </div>
          <div class="col-sm-5 col-lg-4 order-1 order-sm-2 m-0 py-2">
            <div class="sticky-top" style="height: 100vh">
              <div class="map-container rounded-4 shadow-lg" id="map-container">
                <div id="map"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Map Container -->

        <!-- Results Info and Export -->
      </div>
    </section>
  <section id="additionalSupport" class="py-5">
      <div class="container mb-5">
        <div class="row mb-5">
          <div class="col-md-8">
            <h2>Additional Support</h2>
          </div>
          <div class="col-md-4 d-md-flex align-items-center justify-content-end">
            <a id="helpfulLinks" class="text-muted text-sm" href="#helpfulLinksContainer">
              Helpful Links<i class="bi bi-chevron-double-down ms-2"></i
            ></a>
          </div>
        </div>
      <div class="container" id="helpfulLinksContainer">
        <!-- Get Help Now Section -->
        <h3 class="mb-3">Get Help Now</h3>
        <p>
          Individuals seeking treatment or supports for themselves or a loved one can call the toll-free PA Get Help Now helpline at <a href="tel:1-800-662-4357">1-800-662-HELP (4357)</a>. It’s available 24 hours a day, 365 days a year, and staffed by trained professionals.
          A live chat option is also available online or via text message at <a href="tel:717-216-0905">717-216-0905</a> for those seeking help who may not be comfortable speaking to a helpline operator.
        </p>
        <ul class="list-group mb-5">
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="tel:1-800-662-4357" target="_blank" class="d-flex align-items-center text-decoration-none text-dark py-2">
              <i class="bi bi-telephone me-3 fs-4"></i>
              <div>
                <span class="fw-bold d-block">Call 1-800-662-HELP (4357)</span>
              </div>
            </a>
          </li>
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="sms:717-216-0905" target="_blank" class="d-flex align-items-center text-decoration-none text-dark py-2">
              <i class="bi bi-chat-text me-3 fs-4"></i>
              <div>
                <span class="fw-bold d-block">Text 717-216-0905</span>
              </div>
            </a>
          </li>
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://m2.icarol.com/ConsumerRegistration.aspx?org=72331&pid=125&cc=en-US" target="_blank" class="d-flex align-items-center text-decoration-none text-dark py-2">
              <i class="bi bi-chat-dots me-3 fs-4"></i>
              <div>
                <span class="fw-bold d-block">Chat</span>
                <small class="text-muted">A live chat option is available.</small>
              </div>
            </a>
          </li>
        </ul>

        <!-- Find Treatment Section -->
        <h3 class="mb-3">Find Treatment</h3>
        <p class="mb-4">
          Treatment Atlas evaluates addiction treatment facilities’ use of evidence-based best practices, includes an assessment to understand the appropriate level of care, and offers an easy-to-use dashboard to allow those in need and their loved ones to search for and compare facilities using criteria such as location, services offered, and insurance accepted so they can find the best treatment for their unique needs.
          You can also find the most up-to-date licensed drug and alcohol treatment facilities in Pennsylvania or search facility inspection results using our Drug and Alcohol Facility Locator.
        </p>
        <ul class="list-group mb-5">

          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://treatmentatlas.org/" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-search me-3 fs-4"></i>
                </div>
                <div class="col-10">
                <span class="fw-bold d-block">Treatment Atlas</span>
                <small class="text-muted">Find and compare treatment programs for substance use disorder. Available in English and Spanish.</small>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
        </ul>

        <!-- Find Your County Office Section -->
        <h3 class="h4 text-secondary mb-3">Find Your County Drug and Alcohol Office</h3>
        <p>
          <a href="#results" data-category="Single County Authority">County drug and alcohol offices</a>, known as Single County Authorities (SCA) can help with treatment funding, assess the need for treatment or other services, and make referrals to match treatment and/or service needs for individuals or their family members experiencing substance use disorders.
        </p>
        <h3 class="h4 text-secondary mb-3">Resources for Families and Loved Ones</h3>
        <ul class="list-group mb-5">
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="http://al-anon.org/" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-people me-3 fs-4"></i>
                </div>
                <div class="col-10">
                  <span class="fw-bold d-block">Al-Anon</span>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://www.nar-anon.org/find-a-meeting" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-people me-3 fs-4"></i>
                </div>
                <div class="col-10">
                  <span class="fw-bold d-block">Nar-Anon</span>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
        </ul>
        <h3 class="h4 text-secondary mb-3">Additional Resources</h3>
        <ul class="list-group mb-5">
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://pa-navigate.org/" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-people me-3 fs-4"></i>
                </div>
                <div class="col-10">
                  <span class="fw-bold d-block">PA Navigate</span>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://www.pa.gov/agencies/ddap/ddap-search" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-people me-3 fs-4"></i>
                </div>
                <div class="col-10">
                  <span class="fw-bold d-block">DDAP Search</span>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
        </ul>
        <h3 class="h4 text-secondary mb-3">Training</h3>
        <ul class="list-group mb-5">
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://pacertboard.org" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-people me-3 fs-4"></i>
                </div>
                <div class="col-10">
                <span class="fw-bold d-block">Pennsylvania Certification Board (PCB)</span>
                <small class="text-muted">PCB is dedicated to public protection by establishing and monitoring certification standards and examination development for professionals in the behavioral, physical, and community health fields in addition to providing management and consultation services.</small>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
          <li class="list-group-item d-flex align-items-center rounded-3 shadow-sm mb-2">
            <a href="https://www.pa.gov/agencies/ddap/ddap-search" target="_blank" class="w-100 text-decoration-none text-dark py-2">
              <div class="row align-items-center">
                <div class="col-1">
                  <i class="bi bi-people me-3 fs-4"></i>
                </div>
                <div class="col-10">
                <span class="fw-bold d-block">DDAP Training Management System (TMS)</span>
                <small class="text-muted">The Department of Drug and Alcohol Programs' (DDAP) Training Managment System (TMS) offers a catalog of in-person and virtual trainings to maintain your skills and fulfill requirements.</small>
                </div>
                <div class="col-1">
                  <i class="bi bi-box-arrow-up-right"></i>
                </div>
              </div>
            </a>
          </li>
        </ul>
        </div>
      </div>
    </section>
    <footer class="footer">
        <div class="footer__container container">
            <div class="footer__top row">
                <div class="footer__col footer__col--logo col-xl-2 offset-xl-1 col-md-6 offset-md-1"> <span class="footer__logo">
						<a href="https://www.councilsepa.org/">
							<span class="footer__media"><img alt="" decoding="async" loading="lazy" src="https://www.councilsepa.org/wp-content/uploads/2024/03/footer-logo.svg" width="195" height="98"></span> <span class="visually-hidden">The Council of Southeast PA, Inc.</span> </a>
                    </span>
                    <div class="footer__social">
                        <ul class="social-network">
                            <li>
                                <a href="https://www.facebook.com/TheCouncilSEPA" target="_blank" class="dark-icon" rel="noopener noreferrer"> <span class="icon--facebook"></span> <span class="visually-hidden">facebook</span> </a>
                            </li>
                            <li>
                                <a href="https://www.instagram.com/thecouncilsepa" target="_blank" class="dark-icon" rel="noopener noreferrer"> <span class="icon--instagram"></span> <span class="visually-hidden">instagram</span> </a>
                            </li>
                            <li>
                                <a href="https://www.linkedin.com/company/3871792" target="_blank" class="dark-icon" rel="noopener noreferrer"> <span class="icon--linkedin"></span> <span class="visually-hidden">linkedin</span> </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/TheCouncilSEPA" target="_blank" class="dark-icon" rel="noopener noreferrer"> <span class="icon--twitter"></span> <span class="visually-hidden">twitter</span> </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="footer__col footer__col--menu col-xl-2 offset-xl-1 col-md-5">
                    <div class="menu-footer-menu-container">
                        <ul role="list" class="footer__menu">
                            <li id="menu-item-124927" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-124927"><a href="https://www.councilsepa.org/about-us/">About Us</a></li>
                            <li id="menu-item-124928" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-124928"><a href="https://www.councilsepa.org/services/">Services</a></li>
                            <li id="menu-item-124929" class="menu-item menu-item-type-post_type menu-item-object-page current-page-ancestor menu-item-124929"><a href="https://www.councilsepa.org/hubs/">Regional Recovery Hubs</a></li>
                            <li id="menu-item-124930" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-124930"><a href="https://www.councilsepa.org/get-involved/">Get Involved</a></li>
                            <li id="menu-item-130431" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-130431"><a href="https://www.councilsepa.org/sms-optin/">SMS OPT-IN Form</a></li>
                        </ul>
                    </div>
                </div>
                <div class="footer__col footer__col--contact col-xl-3 col-md-6 offset-md-1"> <span class="footer__title">The Council of Southeast PA, Inc.</span>
                    <div class="footer__address">
                        <p>4459 W. Swamp Road
                            <br> Doylestown, PA 18902</p>
                    </div> <span class="footer__contact">
							<span class="footer__contact--row">
																	<a class="tel" href="tel:215.345.6644"> 215.345.6644</a>
																										<a class="email" href="mailto:info@councilsepa.org">info@councilsepa.org</a>
															</span> </span>
                </div>
                <div class="footer__col footer__col--button col-xl-2 offset-xl-0 col-md-5">
                    <div class="footer__buttons"> <a href="https://www.councilsepa.org/donate/" class="button button--primary">Donate</a> </div>
                </div>
            </div>
            <div class="footer__bottom row justify-content-center">
                <div class="col-xl-10">
                    <div class="footer__grid">
                        <div class="footer__grid--left"> <span class="footer__copyright">Copyright 2025</span>
                            <div class="footer__ein">EIN: 12-3456789 </div> <span class="footer__createdby">
								<a href="http://www.elevationweb.org/" target="_blank" title="Nonprofit Website Design" rel="noopener noreferrer">Nonprofit Website
									Design</a> by <a href="https://www.elevationweb.org/portfolio/" target="_blank" title="Elevation Web" rel="noopener noreferrer">Elevation Web</a>
							</span> </div>
                        <div class="footer__grid--right">
                            <div class="footer__links"> <a href="https://www.councilsepa.org/accessibility-policy/" target="_self" role="button">Accessibility Policy</a> <a href="https://www.councilsepa.org/terms-of-use/" target="_self" role="button">Terms of Use</a> <a href="https://www.councilsepa.org/privacy-policy/" target="_self" role="button">Privacy Policy</a> </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
<script>
      // Configuration
      const CONFIG = {
        API_BASE_URL: "https://resourcesdatabaseproxy.crodican.workers.dev/",
        MAPTILER_API_KEY: "1nPjVtGASMJJCaJkeKXQ",
        DEFAULT_PAGE_SIZE: 25,
        DEBOUNCE_DELAY: 300
      };

      // Application State
      const AppState = {
        // Data
        currentData: [],
        totalRows: 0,
        filterOptions: {},

        // UI State
        currentPage: 1,
        recordsPerPage: CONFIG.DEFAULT_PAGE_SIZE,
        currentSort: "",
        sortDirection: "asc",
        isLoading: false,
        currentView: "cards", // 'table' or 'cards'

        // Filters
        activeFilters: {
          search: "",
          County: [],
          "Resource Type": [],
          "Populations Served": [],
          Category: []
        },

        // Map
        map: null
      };

      // API Client
      class APIClient {
        static cache = new Map();
        static cacheTimeout = 2 * 60 * 1000; // 2 minutes cache

        static getCacheKey(endpoint, params) {
          const sortedParams = Object.keys(params)
            .sort()
            .reduce((result, key) => {
              result[key] = Array.isArray(params[key]) ? params[key].sort() : params[key];
              return result;
            }, {});
          return `${endpoint}?${JSON.stringify(sortedParams)}`;
        }

        static async request(endpoint, params = {}) {
          const cacheKey = this.getCacheKey(endpoint, params);

          // Check cache first
          const cached = this.cache.get(cacheKey);
          if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
            console.log("Using cached data for:", cacheKey);
            return cached.data;
          }

          try {
            const url = new URL(endpoint, CONFIG.API_BASE_URL);
            Object.keys(params).forEach((key) => {
              if (Array.isArray(params[key])) {
                params[key].forEach((value) => url.searchParams.append(key, value));
              } else if (params[key] !== null && params[key] !== undefined && params[key] !== "") {
                url.searchParams.append(key, params[key]);
              }
            });

            console.log("API Request:", url.toString());
            const response = await fetch(url);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error?.message || "API request failed");
            }

            // Cache the result
            this.cache.set(cacheKey, {
              data: data.data,
              timestamp: Date.now()
            });

            // Clean old cache entries (keep cache size manageable)
            if (this.cache.size > 50) {
              const oldestKey = this.cache.keys().next().value;
              this.cache.delete(oldestKey);
            }

            return data.data;
          } catch (error) {
            console.error("API Error:", error);
            throw error;
          }
        }

        static clearCache() {
          this.cache.clear();
        }

        static async getFilters() {
          return this.request("filters");
        }

        static async getData(params = {}) {
          return this.request("", params);
        }
      }

      // DOM Elements Cache
      const DOM = {
        init() {
          this.searchInput = document.getElementById("search-input");
          this.searchBtn = document.getElementById("search-btn");
          this.perPageSelect = document.getElementById("per-page-select");
          this.clearFiltersBtn = document.getElementById("clear-filters-btn");

          this.loadingSpinner = document.getElementById("loading-spinner");
          this.tableContainer = document.getElementById("table-container");
          this.cardsContainer = document.getElementById("cards-container");
          this.tableBody = document.getElementById("table-body");
          this.resultsInfo = document.getElementById("results-info");
          this.pagination = document.getElementById("pagination");
          this.exportBtn = document.getElementById("export-btn");

          this.activeFiltersDiv = document.getElementById("active-filters");
          this.filterChipsDiv = document.getElementById("filter-chips");

          this.mapContainer = document.getElementById("map");

          this.tableViewBtn = document.getElementById("table-view-btn");
          this.cardViewBtn = document.getElementById("card-view-btn");
        }
      };

      // Results Manager - NEW
      const ResultsManager = {
        showResultsSection() {
          const resultsSection = document.getElementById('results');
          if (resultsSection) {
            resultsSection.classList.add('show');
            
            // Scroll to results with a slight delay to ensure it's visible
            setTimeout(() => {
              resultsSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
              });
            }, 100);
          }
        },

        hideResultsSection() {
          const resultsSection = document.getElementById('results');
          if (resultsSection) {
            resultsSection.classList.remove('show');
          }
        }
      };

      // Utility Functions
      const Utils = {
        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        },

        escapeHtml(text) {
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;"
          };
          return String(text || "").replace(/[&<>"']/g, (m) => map[m]);
        },

        formatPhoneUrl(phone) {
          return phone ? `tel:${phone.replace(/[^\d+]/g, "")}` : null;
        },

        showLoading() {
          AppState.isLoading = true;
          DOM.loadingSpinner.style.display = "flex";
          DOM.tableContainer.style.display = "none";
          DOM.cardsContainer.style.display = "none";
          DOM.exportBtn.disabled = true;
        },

        hideLoading() {
          AppState.isLoading = false;
          DOM.loadingSpinner.style.display = "none";
          ViewManager.showCurrentView();
        }
      };

      // View Management
      const ViewManager = {
        initialize() {
          DOM.tableViewBtn.addEventListener("click", () => this.switchView("table"));
          DOM.cardViewBtn.addEventListener("click", () => this.switchView("cards"));
        },

        switchView(view) {
          AppState.currentView = view;

          // Update toggle buttons
          DOM.tableViewBtn.classList.toggle("active", view === "table");
          DOM.cardViewBtn.classList.toggle("active", view === "cards");

          this.showCurrentView();

          // Re-render the data in the new view format
          this.renderCurrentView();
        },

        showCurrentView() {
          if (AppState.currentView === "table") {
            DOM.tableContainer.style.display = "block";
            DOM.cardsContainer.style.display = "none";
          } else {
            DOM.tableContainer.style.display = "none";
            DOM.cardsContainer.style.display = "block";
          }
        },

        renderCurrentView() {
          if (AppState.currentData && AppState.currentData.length > 0) {
            if (AppState.currentView === "table") {
              TableRenderer.render(AppState.currentData);
            } else {
              CardRenderer.render(AppState.currentData);
            }
          }
        }
      };

      // Filter Management
      const FilterManager = {
        async loadFilterOptions() {
          try {
            AppState.filterOptions = await APIClient.getFilters();
            this.initializeDropdowns();
            this.initializeSearchControlFilters();
          } catch (error) {
            console.error("Failed to load filter options:", error);
            this.initializeDropdowns();
            this.initializeSearchControlFilters();
          }
        },

        initializeDropdowns() {
          const filterTypes = ["County", "Resource Type", "Populations Served"];

          filterTypes.forEach((filterType) => {
            const options = AppState.filterOptions[filterType] || [];
            this.createFilterDropdown(filterType, options);
          });

          this.initializeCategoryDropdown();
          this.setupEventListeners();
        },

        initializeSearchControlFilters() {
          // Initialize Bootstrap dropdown filters in search controls
          this.createSearchControlDropdown("County", AppState.filterOptions.County || []);
          this.createSearchControlDropdown("Resource Type", AppState.filterOptions["Resource Type"] || []);
          this.createSearchControlDropdown("Populations Served", AppState.filterOptions["Populations Served"] || []);
          this.initializeSearchControlCategoryDropdown();
          this.updateFilterCountBadges();
        },

        createSearchControlDropdown(filterType, options) {
          const dropdownId = this.getSearchControlDropdownId(filterType);
          const dropdown = document.getElementById(dropdownId);

          if (!dropdown || !options.length) return;

          dropdown.innerHTML = options
            .map((option) => {
              const safeId = `sc-${filterType}-${option}`.replace(/[^a-zA-Z0-9-_]/g, "-");
              const isChecked = AppState.activeFilters[filterType]?.includes(option) ? "checked" : "";
              return `
                        <li>
                            <div class="dropdown-item-check">
                                <input type="checkbox" id="${safeId}" value="${option}" ${isChecked} onchange="FilterManager.handleSearchControlFilterChange('${filterType}', '${option}', this.checked)">
                                <label for="${safeId}">${option}</label>
                            </div>
                        </li>
                    `;
            })
            .join("");
        },

        initializeSearchControlCategoryDropdown() {
          const categories = AppState.filterOptions.Category || {};
          const allCategories = new Set();
          Object.values(categories).forEach((cats) => cats.forEach((cat) => allCategories.add(cat)));

          this.createSearchControlDropdown("Category", Array.from(allCategories).sort());
        },

        updateSearchControlCategoryDropdown() {
          const selectedResourceTypes = AppState.activeFilters["Resource Type"];
          const categories = AppState.filterOptions.Category || {};

          if (selectedResourceTypes.length === 0) {
            this.initializeSearchControlCategoryDropdown();
            return;
          }

          const availableCategories = new Set();
          selectedResourceTypes.forEach((resourceType) => {
            if (categories[resourceType]) {
              categories[resourceType].forEach((cat) => availableCategories.add(cat));
            }
          });

          this.createSearchControlDropdown("Category", Array.from(availableCategories).sort());

          AppState.activeFilters.Category = AppState.activeFilters.Category.filter((cat) =>
            availableCategories.has(cat)
          );
        },

        getSearchControlDropdownId(filterType) {
          const mapping = {
            County: "county-dropdown-menu",
            "Resource Type": "resource-type-dropdown-menu",
            Category: "category-dropdown-menu",
            "Populations Served": "populations-dropdown-menu"
          };
          return mapping[filterType];
        },

        handleSearchControlFilterChange(filterType, value, checked) {
          if (checked) {
            if (!AppState.activeFilters[filterType].includes(value)) {
              AppState.activeFilters[filterType].push(value);
            }
          } else {
            AppState.activeFilters[filterType] = AppState.activeFilters[filterType].filter((v) => v !== value);
          }

          if (filterType === "Resource Type") {
            this.updateCategoryDropdown();
            this.updateSearchControlCategoryDropdown();
          }

          // Update both dropdown systems
          this.syncDropdowns(filterType);

          // Clear cache when filters change to ensure fresh data
          APIClient.clearCache();

          this.updateUI();
          AppState.currentPage = 1;
          DataManager.loadData();
        },

        syncDropdowns(filterType) {
          // Sync table header dropdowns with search control dropdowns
          const tableDropdownId = this.getDropdownId(filterType);
          const tableDropdown = document.getElementById(tableDropdownId);

          if (tableDropdown) {
            const checkboxes = tableDropdown.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((checkbox) => {
              const isActive = AppState.activeFilters[filterType]?.includes(checkbox.value);
              checkbox.checked = isActive;
            });
          }

          // Update search control dropdowns
          const searchDropdownId = this.getSearchControlDropdownId(filterType);
          const searchDropdown = document.getElementById(searchDropdownId);

          if (searchDropdown) {
            const checkboxes = searchDropdown.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((checkbox) => {
              const isActive = AppState.activeFilters[filterType]?.includes(checkbox.value);
              checkbox.checked = isActive;
            });
          }
        },

        updateFilterCountBadges() {
          ["County", "Resource Type", "Category", "Populations Served"].forEach((filterType) => {
            const count = AppState.activeFilters[filterType]?.length || 0;
            const badgeId = this.getCountBadgeId(filterType);
            const badge = document.getElementById(badgeId);

            if (badge) {
              if (count > 0) {
                badge.textContent = count;
                badge.style.display = "flex";
              } else {
                badge.style.display = "none";
              }
            }
          });
        },

        getCountBadgeId(filterType) {
          const mapping = {
            County: "county-count-badge",
            "Resource Type": "resource-type-count-badge",
            Category: "category-count-badge",
            "Populations Served": "populations-count-badge"
          };
          return mapping[filterType];
        },

        createFilterDropdown(filterType, options) {
          const dropdownId = this.getDropdownId(filterType);
          const dropdown = document.getElementById(dropdownId);

          if (!dropdown || !options.length) return;

          dropdown.innerHTML = options
            .map((option) => {
              const safeId = `th-${filterType}-${option}`.replace(/[^a-zA-Z0-9-_]/g, "-");
              const isChecked = AppState.activeFilters[filterType]?.includes(option) ? "checked" : "";
              return `
                        <div class="filter-option">
                            <input type="checkbox" id="${safeId}" value="${option}" ${isChecked}>
                            <label for="${safeId}">${option}</label>
                        </div>
                    `;
            })
            .join("");

          dropdown.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
            checkbox.addEventListener("change", (e) => {
              this.handleFilterChange(filterType, e.target.value, e.target.checked);
            });
          });
        },

        initializeCategoryDropdown() {
          const categories = AppState.filterOptions.Category || {};
          const allCategories = new Set();
          Object.values(categories).forEach((cats) => cats.forEach((cat) => allCategories.add(cat)));

          this.createFilterDropdown("Category", Array.from(allCategories).sort());
        },

        updateCategoryDropdown() {
          const selectedResourceTypes = AppState.activeFilters["Resource Type"];
          const categories = AppState.filterOptions.Category || {};

          if (selectedResourceTypes.length === 0) {
            this.initializeCategoryDropdown();
            return;
          }

          const availableCategories = new Set();
          selectedResourceTypes.forEach((resourceType) => {
            if (categories[resourceType]) {
              categories[resourceType].forEach((cat) => availableCategories.add(cat));
            }
          });

          this.createFilterDropdown("Category", Array.from(availableCategories).sort());

          AppState.activeFilters.Category = AppState.activeFilters.Category.filter((cat) =>
            availableCategories.has(cat)
          );
        },

        handleFilterChange(filterType, value, checked) {
          if (checked) {
            if (!AppState.activeFilters[filterType].includes(value)) {
              AppState.activeFilters[filterType].push(value);
            }
          } else {
            AppState.activeFilters[filterType] = AppState.activeFilters[filterType].filter((v) => v !== value);
          }

          if (filterType === "Resource Type") {
            this.updateCategoryDropdown();
            this.updateSearchControlCategoryDropdown();
          }

          // Sync both dropdown systems
          this.syncDropdowns(filterType);

          // Clear cache when filters change to ensure fresh data
          APIClient.clearCache();

          this.updateUI();
          AppState.currentPage = 1;
          DataManager.loadData();
        },

        setupEventListeners() {
          document.querySelectorAll(".filter-header").forEach((header) => {
            header.addEventListener("click", (e) => {
              e.stopPropagation();
              const column = header.dataset.column;
              if (this.isFilterColumn(column) && !e.target.closest(".resize-handle")) {
                this.toggleDropdown(column);
              }
            });
          });

          document.addEventListener("click", (e) => {
            if (!e.target.closest(".filter-header")) {
              this.closeAllDropdowns();
            }
          });
        },

        isFilterColumn(column) {
          return ["County", "Resource Type", "Category", "Populations Served"].includes(column);
        },

        toggleDropdown(filterType) {
          const dropdownId = this.getDropdownId(filterType);
          const dropdown = document.getElementById(dropdownId);

          if (!dropdown) return;

          this.closeAllDropdowns();
          dropdown.classList.toggle("show");
        },

        closeAllDropdowns() {
          document.querySelectorAll(".filter-dropdown").forEach((dropdown) => {
            dropdown.classList.remove("show");
          });
        },

        getDropdownId(filterType) {
          const mapping = {
            County: "county-filter-dropdown",
            "Resource Type": "resource-type-filter-dropdown",
            Category: "category-filter-dropdown",
            "Populations Served": "populations-filter-dropdown"
          };
          return mapping[filterType];
        },

        clearAll() {
          AppState.activeFilters = {
            search: "",
            County: [],
            "Resource Type": [],
            "Populations Served": [],
            Category: []
          };

          DOM.searchInput.value = "";

          // Clear table header dropdowns
          document.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach((checkbox) => {
            checkbox.checked = false;
          });

          // Clear search control dropdowns
          document.querySelectorAll('[id$="-dropdown-menu"] input[type="checkbox"]').forEach((checkbox) => {
            checkbox.checked = false;
          });

          this.updateCategoryDropdown();
          this.updateSearchControlCategoryDropdown();
          this.updateUI();
          
          // Show county search section when filters are cleared
          CountyCardManager.showCountySearch();
        },

        updateUI() {
          this.updateIndicators();
          this.updateFilterChips();
          this.updateFilterCountBadges();
        },

        updateIndicators() {
          ["County", "Resource Type", "Category", "Populations Served"].forEach((filterType) => {
            const indicatorId = this.getDropdownId(filterType).replace("-dropdown", "-indicator");
            const indicator = document.getElementById(indicatorId);

            if (indicator) {
              if (AppState.activeFilters[filterType]?.length > 0) {
                indicator.classList.add("active");
              } else {
                indicator.classList.remove("active");
              }
            }
          });
        },

        updateFilterChips() {
          const chips = [];

          if (AppState.activeFilters.search) {
            chips.push({
              type: "search",
              value: AppState.activeFilters.search,
              label: `Search: "${AppState.activeFilters.search}"`
            });
          }

          ["County", "Resource Type", "Category", "Populations Served"].forEach((filterType) => {
            if (AppState.activeFilters[filterType]?.length > 0) {
              AppState.activeFilters[filterType].forEach((value) => {
                chips.push({
                  type: filterType,
                  value: value,
                  label: `${filterType}: ${value}`
                });
              });
            }
          });

          if (chips.length > 0) {
            DOM.activeFiltersDiv.style.display = "block";
            DOM.filterChipsDiv.innerHTML = chips
              .map(
                (chip) =>
                  `<span class="filter-chip">
                            ${chip.label}
                            <button type="button" class="btn-close" onclick="FilterManager.removeFilter('${chip.type}', '${chip.value}')" aria-label="Remove filter"></button>
                        </span>`
              )
              .join("");
          } else {
            DOM.activeFiltersDiv.style.display = "none";
          }
        },

        removeFilter(type, value) {
          if (type === "search") {
            AppState.activeFilters.search = "";
            DOM.searchInput.value = "";
          } else if (AppState.activeFilters[type]) {
            AppState.activeFilters[type] = AppState.activeFilters[type].filter((v) => v !== value);

            // Update both dropdown systems
            this.syncDropdowns(type);
          }

          if (type === "Resource Type") {
            this.updateCategoryDropdown();
            this.updateSearchControlCategoryDropdown();
          }

          AppState.currentPage = 1;
          this.updateUI();
          DataManager.loadData();
        }
      };

      // Data Management
      const DataManager = {
        currentRequest: null, // Track current request to prevent race conditions

        async loadData() {
          // Cancel any existing request
          if (this.currentRequest) {
            console.log("Cancelling previous request");
            return; // Don't start new request if one is pending
          }

          Utils.showLoading();

          try {
            const params = this.buildRequestParams();
            this.currentRequest = APIClient.getData(params);
            const data = await this.currentRequest;

            AppState.currentData = data.list || [];
            AppState.totalRows = data.pageInfo?.totalRows || 0;

            // Render based on current view
            if (AppState.currentView === "table") {
              TableRenderer.render(AppState.currentData);
            } else {
              CardRenderer.render(AppState.currentData);
            }

            PaginationManager.render();
            this.updateResultsInfo();
            MapManager.updateMarkers();

            DOM.exportBtn.disabled = AppState.currentData.length === 0;
          } catch (error) {
            console.error("Error loading data:", error);
            this.showError(error.message);
          } finally {
            this.currentRequest = null;
            Utils.hideLoading();
          }
        },

        buildRequestParams() {
          const params = {
            page: AppState.currentPage,
            limit: AppState.recordsPerPage
          };

          if (AppState.currentSort) {
            const sortParam = AppState.sortDirection === "desc" ? `-${AppState.currentSort}` : AppState.currentSort;
            params.sort = sortParam;
          }

          if (AppState.activeFilters.search) {
            params.search = AppState.activeFilters.search;
          }

          // Add array filters
          ["County", "Resource Type", "Category"].forEach((filterType) => {
            if (AppState.activeFilters[filterType]?.length > 0) {
              params[filterType] = AppState.activeFilters[filterType];
            }
          });

          // Special handling for Populations Served
          if (AppState.activeFilters["Populations Served"]?.length > 0) {
            params.Populations = AppState.activeFilters["Populations Served"];
          }

          return params;
        },

        updateResultsInfo() {
          const start = (AppState.currentPage - 1) * AppState.recordsPerPage + 1;
          const end = Math.min(AppState.currentPage * AppState.recordsPerPage, AppState.totalRows);

          if (AppState.totalRows === 0) {
            DOM.resultsInfo.textContent = "No resources found";
          } else {
            DOM.resultsInfo.textContent = `Showing ${start}-${end} of ${AppState.totalRows} resources`;
          }
        },

        showError(message) {
          if (AppState.currentView === "table") {
            DOM.tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center text-danger py-4">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error: ${Utils.escapeHtml(message)}
                            </td>
                        </tr>
                    `;
          } else {
            DOM.cardsContainer.innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error: ${Utils.escapeHtml(message)}
                        </div>
                    `;
          }
          DOM.resultsInfo.textContent = "Error loading data";
        }
      };

      // Table Rendering
      const TableRenderer = {
        render(data) {
          if (!data || data.length === 0) {
            DOM.tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center text-muted py-4">
                                <i class="bi bi-inbox me-2"></i>
                                No resources found with the current filters.
                            </td>
                        </tr>
                    `;
            return;
          }

          DOM.tableBody.innerHTML = data.map((resource) => this.renderRow(resource)).join("");
        },

        renderRow(resource) {
          const resourceIdentifier = resource.ID || resource["Location Name"] || "unknown";
          return `
                    <tr class="table-row-clickable" 
                        data-resource-id="${resourceIdentifier}"
                        ${
                          resource.Longitude && resource.Latitude
                            ? `data-longitude="${resource.Longitude}" data-latitude="${resource.Latitude}"`
                            : ""
                        }>
                        <td class="text-nowrap">
                            <div class="location-name-cell">
                                ${
                                  resource.Image
                                    ? `<img src="${Utils.escapeHtml(resource.Image)}" alt="Location" class="location-image" onerror="this.style.display='none'">`
                                    : ""
                                }
                                <strong>${Utils.escapeHtml(resource["Location Name"] || "N/A")}</strong>
                            </div>
                        </td>
                        <td class="text-nowrap">${Utils.escapeHtml(resource.Organization || "N/A")}</td>
                        <td class="text-nowrap">
                            ${
                              resource.County
                                ? `<span class="badge badge-county">${Utils.escapeHtml(resource.County)}</span>`
                                : "N/A"
                            }
                        </td>
                        <td class="text-nowrap">
                            ${
                              resource["Resource Type"]
                                ? `<span class="badge badge-resource-type">${Utils.escapeHtml(resource["Resource Type"])}</span>`
                                : "N/A"
                            }
                        </td>
                        <td class="text-nowrap">
                            ${
                              resource.Category
                                ? resource.Category.split(",")
                                    .map(
                                      (cat) =>
                                        `<span class="badge badge-category">${Utils.escapeHtml(cat.trim())}</span>`
                                    )
                                    .join(" ")
                                : "N/A"
                            }
                        </td>
                        <td class="text-nowrap">
                            ${
                              resource["Populations Served"]
                                ? resource["Populations Served"]
                                    .split(",")
                                    .map(
                                      (pop) =>
                                        `<span class="badge badge-population">${Utils.escapeHtml(pop.trim())}</span>`
                                    )
                                    .join(" ")
                                : "N/A"
                            }
                        </td>
                        <td class="text-nowrap" onclick="event.stopPropagation()">
                            ${
                              resource.Phone
                                ? `<a href="${Utils.formatPhoneUrl(resource.Phone)}" class="btn-link text-nowrap">
                                    <i class="bi bi-telephone me-1"></i>${Utils.escapeHtml(resource.Phone)}
                                </a>`
                                : "N/A"
                            }
                        </td>
                        <td onclick="event.stopPropagation()">
                            ${
                              resource.Website
                                ? `<a href="${Utils.escapeHtml(resource.Website)}" target="_blank" class="btn-link text-nowrap" title="Visit Website">
                                    <i class="bi bi-globe"></i> Website
                                </a>`
                                : "N/A"
                            }
                        </td>
                        <td class="text-nowrap">${Utils.escapeHtml(resource.Address || "N/A")}</td>
                        <td>${Utils.escapeHtml(resource.City || "N/A")}</td>
                        <td>${Utils.escapeHtml(resource.State || "N/A")}</td>
                        <td>${Utils.escapeHtml(resource["Zip Code"] || "N/A")}</td>
                    </tr>
                `;
        }
      };

      // Card Rendering
      const CardRenderer = {
        render(data) {
          if (!data || data.length === 0) {
            DOM.cardsContainer.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox me-2" style="font-size: 2rem;"></i>
                            <h5>No resources found with the current filters.</h5>
                        </div>
                    `;
            return;
          }

          DOM.cardsContainer.innerHTML = data.map((resource) => this.renderCard(resource)).join("");
        },

        renderCard(resource) {
          const resourceIdentifier = resource.ID || resource["Location Name"] || "unknown";
          const phoneUrl = Utils.formatPhoneUrl(resource.Phone) || "#";

          return `
                    <div class="resourceCard shadow-lg text-bg-white mb-4" data-resource-id="${resourceIdentifier}">
                        <div class="row no-gutters p-0">
                            <div class="card-sidenav col-2 d-flex flex-column justify-content-between align-items-center p-0">
                                <a href="${resource.Website || "#"}" class="d-flex align-items-center justify-content-center flex-grow-1 w-100 sidenav-button" target="_blank" rel="noopener noreferrer" aria-label="Visit website for ${resource["Location Name"] || "resource"}">
                                    <i class="bi bi-globe"></i>
                                </a>
                                <a href="${phoneUrl}" class="d-flex align-items-center justify-content-center flex-grow-1 w-100 sidenav-button" aria-label="Call ${resource["Location Name"] || "resource"}">
                                    <i class="bi bi-telephone-fill"></i>
                                </a>
                                <button class="map-fly-btn d-flex align-items-center justify-content-center flex-grow-1 w-100 border-0 sidenav-button" 
                                        ${
                                          resource.Longitude && resource.Latitude
                                            ? `data-longitude="${resource.Longitude}" data-latitude="${resource.Latitude}"`
                                            : "disabled"
                                        } 
                                        data-resource-id="${resourceIdentifier}" 
                                        aria-label="View ${resource["Location Name"] || "resource"} on map"
                                        title="View on map">
                                    <i class="bi bi-geo-alt-fill"></i>
                                </button>
                            </div>
                            <div class="card-body col-10 p-4">
                                <h3 class="text-secondary">${Utils.escapeHtml(resource["Location Name"] || "N/A")}</h3>
                                <h5 class="text-dark">${Utils.escapeHtml(resource.Organization || "N/A")}</h5>
                                
                                <div class="mb-2">
                                    ${
                                      resource["Resource Type"]
                                        ? `<span class="card-badge">${Utils.escapeHtml(resource["Resource Type"])}</span>`
                                        : ""
                                    }
                                    ${
                                      resource.Category
                                        ? resource.Category.split(",")
                                            .map(
                                              (cat) => `<span class="card-badge">${Utils.escapeHtml(cat.trim())}</span>`
                                            )
                                            .join("")
                                        : ""
                                    }
                                </div>
                                
                                <h6>Phone: ${Utils.escapeHtml(resource.Phone || "N/A")}</h6>
                                <p>
                                    ${Utils.escapeHtml(resource.Address || "N/A")}<br>
                                    ${Utils.escapeHtml(resource.City || "N/A")}, ${Utils.escapeHtml(resource.State || "N/A")}, ${Utils.escapeHtml(resource["Zip Code"] || "N/A")}<br>
                                    ${
                                      resource["Google Maps URL"]
                                        ? `<strong><a href="${Utils.escapeHtml(resource["Google Maps URL"])}" class="text-secondary" target="_blank" rel="noopener noreferrer">Directions</a></strong>`
                                        : ""
                                    }
                                </p>
                                
                                ${
                                  resource["Populations Served"] && resource["Populations Served"].trim() !== ""
                                    ? `<h6>Populations Served:</h6>
                                    <div class="mb-2">
                                        ${(resource["Populations Served"] || "")
                                          .split(",")
                                          .map((pop) => pop.trim())
                                          .filter((pop) => pop)
                                          .map((pop) => `<span class="card-badge">${Utils.escapeHtml(pop)}</span>`)
                                          .join("")}
                                    </div>`
                                    : ""
                                }
                                
                                ${
                                  resource.County
                                    ? `<h6>County:</h6>
                                    <div class="mb-2">
                                        <span class="card-badge">${Utils.escapeHtml(resource.County)}</span>
                                    </div>`
                                    : ""
                                }
                                
                                <div class="row d-flex justify-content-end position-relative">
                                    ${
                                      resource.Image
                                        ? `<div class="col-md-auto d-flex justify-content-end align-items-end p-2" style="position:relative">
                                            <img class="cardImage" onerror="this.style.display='none'" src="${Utils.escapeHtml(resource.Image)}" alt="${Utils.escapeHtml(resource.Organization || resource["Location Name"] || "Resource logo")}">
                                        </div>`
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }
      };

      // Pagination Management
      const PaginationManager = {
        render() {
          const totalPages = Math.ceil(AppState.totalRows / AppState.recordsPerPage);

          if (totalPages <= 1) {
            DOM.pagination.innerHTML = "";
            return;
          }

          const startPage = Math.max(1, AppState.currentPage - 2);
          const endPage = Math.min(totalPages, AppState.currentPage + 2);

          let html = this.createPageButton("prev", AppState.currentPage - 1, AppState.currentPage <= 1);

          if (startPage > 1) {
            html += this.createPageButton("page", 1);
            if (startPage > 2) {
              html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
          }

          for (let i = startPage; i <= endPage; i++) {
            html += this.createPageButton("page", i, false, i === AppState.currentPage);
          }

          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            html += this.createPageButton("page", totalPages);
          }

          html += this.createPageButton("next", AppState.currentPage + 1, AppState.currentPage >= totalPages);

          DOM.pagination.innerHTML = html;
        },

        createPageButton(type, page, disabled = false, active = false) {
          const disabledClass = disabled ? "disabled" : "";
          const activeClass = active ? "active" : "";

          if (type === "prev") {
            return `
                        <li class="page-item ${disabledClass}">
                            <a class="page-link" href="#" onclick="PaginationManager.changePage(${page})" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    `;
          } else if (type === "next") {
            return `
                        <li class="page-item ${disabledClass}">
                            <a class="page-link" href="#" onclick="PaginationManager.changePage(${page})" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    `;
          } else {
            return `
                        <li class="page-item ${activeClass}">
                            <a class="page-link" href="#" onclick="PaginationManager.changePage(${page})">${page}</a>
                        </li>
                    `;
          }
        },

        changePage(page) {
          const totalPages = Math.ceil(AppState.totalRows / AppState.recordsPerPage);
          if (page < 1 || page > totalPages) return;

          AppState.currentPage = page;
          DataManager.loadData();
        }
      };

      // Map Interaction Management
      const MapInteraction = {
        flyToLocation(longitude, latitude, resourceId) {
          if (!AppState.map || !longitude || !latitude) {
            console.warn("Cannot fly to location: missing map or coordinates");
            return;
          }

          const lng = parseFloat(longitude);
          const lat = parseFloat(latitude);

          if (isNaN(lng) || isNaN(lat)) {
            console.warn("Invalid coordinates provided");
            return;
          }

          // Show feedback to user
          this.showMapFlyFeedback();

          // Fly to the location
          AppState.map.flyTo({
            center: [lng, lat],
            zoom: 15,
            duration: 1500, // Animation duration in milliseconds
            essential: true // Animation is considered essential for accessibility
          });

          // Find and open the corresponding marker popup
          setTimeout(() => {
            const marker = MapManager.markerMap.get(resourceId);
            if (marker) {
              marker.togglePopup();
              // Ensure popup is open
              if (!marker.getPopup().isOpen()) {
                marker.togglePopup();
              }
            }
          }, 800); // Delay to allow fly animation to start
        },

        showMapFlyFeedback() {
          // Create temporary notification
          const notification = document.createElement("div");
          notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #55298a;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 6px;
                    z-index: 9999;
                    font-size: 0.9rem;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    animation: slideIn 0.3s ease-out;
                `;
          notification.innerHTML = `
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    Flying to location on map...
                `;

          // Add slide-in animation
          const style = document.createElement("style");
          style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
          document.head.appendChild(style);

          document.body.appendChild(notification);

          // Remove notification after 2 seconds
          setTimeout(() => {
            notification.style.animation = "slideIn 0.3s ease-out reverse";
            setTimeout(() => {
              document.body.removeChild(notification);
              document.head.removeChild(style);
            }, 300);
          }, 2000);
        },

        handleTableRowClick(event) {
          // Don't trigger if clicking on links or buttons
          if (event.target.closest("a, button") || event.target.onclick) {
            return;
          }

          const row = event.target.closest("tr.table-row-clickable");
          if (!row) return;

          const longitude = row.dataset.longitude;
          const latitude = row.dataset.latitude;
          const resourceId = row.dataset.resourceId;

          if (longitude && latitude) {
            this.flyToLocation(longitude, latitude, resourceId);
          }
        },

        handleMapFlyButtonClick(event) {
          event.preventDefault();
          event.stopPropagation();

          const button = event.target.closest(".map-fly-btn");
          if (!button || button.disabled) return;

          const longitude = button.dataset.longitude;
          const latitude = button.dataset.latitude;
          const resourceId = button.dataset.resourceId;

          if (longitude && latitude) {
            this.flyToLocation(longitude, latitude, resourceId);
          }
        }
      };

      const MapManager = {
        markerMap: new Map(), // Track markers by ID for reuse

        initialize() {
          AppState.map = new maplibregl.Map({
            container: "map",
            style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${CONFIG.MAPTILER_API_KEY}`,
            center: [-75.1652, 39.9526], // Philadelphia center
            zoom: 9
          });

          AppState.map.addControl(new maplibregl.NavigationControl(), "top-right");
        },

        async updateMarkers() {
          try {
            // Use current data from the table instead of separate API call
            const markerData = this.processDataForMap(AppState.currentData);

            if (!markerData || markerData.length === 0) {
              this.clearAllMarkers();
              this.centerOnPhiladelphia();
              return;
            }

            // Get current marker IDs
            const currentMarkerIds = new Set(this.markerMap.keys());
            const newMarkerIds = new Set(markerData.map((d) => d.id).filter(Boolean));

            // Remove markers that are no longer needed
            currentMarkerIds.forEach((id) => {
              if (!newMarkerIds.has(id)) {
                const marker = this.markerMap.get(id);
                marker.remove();
                this.markerMap.delete(id);
              }
            });

            const bounds = new maplibregl.LngLatBounds();
            let hasValidBounds = false;

            // Add or update markers
            markerData.forEach((location) => {
              let marker = this.markerMap.get(location.id);
              const popup = this.createPopup(location);

              if (marker) {
                // Update existing marker position and popup
                marker.setLngLat([location.lng, location.lat]);
                marker.setPopup(popup);
              } else {
                // Create new marker
                marker = new maplibregl.Marker({ color: "#55298a" })
                  .setLngLat([location.lng, location.lat])
                  .setPopup(popup)
                  .addTo(AppState.map);
                this.markerMap.set(location.id, marker);
              }

              bounds.extend([location.lng, location.lat]);
              hasValidBounds = true;
            });

            // Fit map to markers only if we have valid bounds
            if (hasValidBounds) {
              if (markerData.length === 1) {
                AppState.map.flyTo({
                  center: [markerData[0].lng, markerData[0].lat],
                  zoom: 12
                });
              } else {
                AppState.map.fitBounds(bounds, {
                  padding: 50,
                  maxZoom: 15
                });
              }
            }
          } catch (error) {
            console.error("Error updating map markers:", error);
            this.centerOnPhiladelphia();
          }
        },

        clearAllMarkers() {
          this.markerMap.forEach((marker) => marker.remove());
          this.markerMap.clear();
        },

        processDataForMap(data) {
          if (!data || !Array.isArray(data)) return [];

          return data
            .map((record) => {
              const lat = parseFloat(record.Latitude);
              const lon = parseFloat(record.Longitude);

              // Skip records without valid coordinates
              if (isNaN(lat) || isNaN(lon)) {
                return null;
              }

              return {
                id: record.ID || record["Location Name"] || Math.random().toString(36),
                lat: lat,
                lng: lon,
                name: record["Location Name"] || "N/A",
                organization: record.Organization || "N/A",
                address: record.Address || "N/A",
                city: record.City || "N/A",
                state: record.State || "N/A",
                zipCode: record["Zip Code"] || "N/A",
                phone: record.Phone || null,
                website: record.Website || null,
                googleMapsUrl: record["Google Maps URL"] || null
              };
            })
            .filter((marker) => marker !== null);
        },

        createPopup(location) {
          const popupContent = `
                    <div class="map-popup-container" style="max-width: 300px;">
                        <div class="row no-gutters py-0 px-1">
                            <div class="card-body col-12 p-3">
                                <h3 class="text-secondary fw-bold lh-1 py-0">${location.name}</h3>
                                <h5 class="text-dark fw-light lh-1 py-0">${location.organization}</h5>
                                <p class="text-body-tertiary lh-1 py-0 mb-1">${location.address}<br />
                                    ${location.city}, ${location.state}, ${location.zipCode}
                                </p>
                                <p class="mb-0">
                                    ${location.googleMapsUrl ? `<a class="text-primary fw-bold d-block mb-1" href="${location.googleMapsUrl}" target="_blank" rel="noopener noreferrer"><i class="bi bi-geo-alt-fill"></i> Directions</a>` : ""}
                                    ${location.website ? `<a class="text-primary d-block mb-1" href="${location.website}" target="_blank" rel="noopener noreferrer"><i class="bi bi-globe"></i> Website</a>` : ""}
                                    ${location.phone ? `<a class="text-primary text-decoration-none fw-bold d-block" href="tel:${location.phone}"><i class="bi bi-telephone-fill text-primary"></i> ${location.phone}</a>` : "N/A"}
                                </p>
                            </div>
                        </div>
                    </div>`;

          return new maplibregl.Popup({ offset: 25, maxWidth: "320px" }).setHTML(popupContent);
        },

        centerOnPhiladelphia() {
          AppState.map.flyTo({
            center: [-75.1652, 39.9526],
            zoom: 9
          });
        }
      };

      // Column Resizing
      const ColumnResizer = {
        initialize() {
          const headers = document.querySelectorAll("thead th");

          headers.forEach((header) => {
            const resizeHandle = document.createElement("div");
            resizeHandle.className = "resize-handle";
            resizeHandle.title = "Drag to resize column";
            header.appendChild(resizeHandle);

            this.setupResizeHandlers(header, resizeHandle);
          });
        },

        setupResizeHandlers(header, resizeHandle) {
          let isResizing = false;
          let startX = 0;
          let startWidth = 0;

          resizeHandle.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();

            isResizing = true;
            startX = e.clientX;
            startWidth = header.offsetWidth;

            document.body.style.cursor = "col-resize";
            document.body.style.userSelect = "none";
            header.style.borderRight = "2px solid #20cb98";

            document.addEventListener("selectstart", this.preventSelection);
          });

          document.addEventListener("mousemove", (e) => {
            if (!isResizing) return;

            e.preventDefault();
            const diff = e.clientX - startX;
            const newWidth = Math.max(80, startWidth + diff);

            header.style.width = newWidth + "px";
            header.style.minWidth = newWidth + "px";
            header.style.maxWidth = newWidth + "px";
          });

          document.addEventListener("mouseup", () => {
            if (isResizing) {
              isResizing = false;

              document.body.style.cursor = "";
              document.body.style.userSelect = "";
              header.style.borderRight = "1px solid rgba(255, 255, 255, 0.2)";

              document.removeEventListener("selectstart", this.preventSelection);
            }
          });

          resizeHandle.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
          });
        },

        preventSelection(e) {
          e.preventDefault();
          return false;
        }
      };

      // Sorting
      const SortManager = {
        initialize() {
          document.querySelectorAll("th.sortable").forEach((th) => {
            th.addEventListener("click", (e) => {
              if (!e.target.closest(".filter-dropdown") && !e.target.closest(".resize-handle")) {
                this.handleSort(th.dataset.column);
              }
            });
          });
        },

        handleSort(column) {
          if (AppState.currentSort === column) {
            AppState.sortDirection = AppState.sortDirection === "asc" ? "desc" : "asc";
          } else {
            AppState.currentSort = column;
            AppState.sortDirection = "asc";
          }

          this.updateSortIndicators();
          AppState.currentPage = 1;
          DataManager.loadData();
        },

        updateSortIndicators() {
          document.querySelectorAll("th.sortable").forEach((th) => {
            th.classList.remove("sort-asc", "sort-desc");
          });

          const sortedTh = document.querySelector(`th[data-column="${AppState.currentSort}"]`);
          if (sortedTh) {
            sortedTh.classList.add(AppState.sortDirection === "asc" ? "sort-asc" : "sort-desc");
          }
        },

        clearSort() {
          AppState.currentSort = "";
          AppState.sortDirection = "asc";
          document.querySelectorAll("th.sortable").forEach((th) => {
            th.classList.remove("sort-asc", "sort-desc");
          });
        }
      };

      // Export functionality
      const ExportManager = {
        exportToCSV() {
          if (AppState.currentData.length === 0) return;

          const headers = [
            "Location Name",
            "Organization",
            "County",
            "Resource Type",
            "Category",
            "Populations Served",
            "Phone",
            "Website",
            "Address",
            "City",
            "State",
            "Zip Code"
          ];

          const csvContent = [
            headers.join(","),
            ...AppState.currentData.map((resource) => {
              return headers
                .map((header) => {
                  const value = resource[header] || "";
                  return `"${String(value).replace(/"/g, '""')}"`;
                })
                .join(",");
            })
          ].join("\n");

          const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);

          link.setAttribute("href", url);
          link.setAttribute("download", `resources_export_${new Date().toISOString().split("T")[0]}.csv`);
          link.style.visibility = "hidden";

          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      };

      // County Card Management - UPDATED
      const CountyCardManager = {
        initialize() {
          this.setupEventListeners();
        },

        setupEventListeners() {
          // Add event listeners to county cards
          document.addEventListener('click', (e) => {
            const countyCard = e.target.closest('.county-card');
            if (countyCard) {
              e.preventDefault();
              this.handleCountyCardClick(countyCard);
            }
          });

          // Add event listener for "See all Counties" link
          const allCountiesLink = document.getElementById('allCounties');
          if (allCountiesLink) {
            allCountiesLink.addEventListener('click', (e) => {
              e.preventDefault();
              this.handleSeeAllCountiesClick();
            });
          }
        },

        handleCountyCardClick(card) {
          const county = card.dataset.county;
          if (!county) return;

          // Clear existing county filters and add the selected one
          AppState.activeFilters.County = [county];

          // Reset search
          AppState.activeFilters.search = "";
          DOM.searchInput.value = "";

          // Reset to first page
          AppState.currentPage = 1;

          // Clear cache to ensure fresh data
          APIClient.clearCache();

          // Update all filter UI components
          FilterManager.syncDropdowns('County');
          FilterManager.updateUI();

          // Hide the county search section
          this.hideCountySearch();

          // Show the results section
          ResultsManager.showResultsSection();

          // Load filtered data
          DataManager.loadData();
        },

        handleSeeAllCountiesClick() {
          // Clear all filters
          AppState.activeFilters = {
            search: "",
            County: [],
            "Resource Type": [],
            "Populations Served": [],
            Category: []
          };

          DOM.searchInput.value = "";

          // Reset to first page
          AppState.currentPage = 1;

          // Clear cache
          APIClient.clearCache();

          // Update filter UI
          FilterManager.clearAll();

          // Hide county search section
          this.hideCountySearch();

          // Show results section
          ResultsManager.showResultsSection();

          // Load all data
          DataManager.loadData();
        },

        hideCountySearch() {
          const countySearchSection = document.getElementById('countySearch');
          if (countySearchSection) {
            countySearchSection.style.display = 'none';
          }
        },

        showCountySearch() {
          const countySearchSection = document.getElementById('countySearch');
          if (countySearchSection) {
            countySearchSection.style.display = 'block';
          }
          
          // Hide results section when showing county search
          ResultsManager.hideResultsSection();
        }
      };

      // Event Handlers - UPDATED WITH CATEGORY LINK FUNCTIONALITY
      const EventHandlers = {
        initialize() {
          // Search
          DOM.searchBtn.addEventListener("click", this.handleSearch);
          DOM.searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault(); // Prevent form submission
              this.handleSearch();
            }
          });

          // Debounced search on input (but only show results on explicit search)
          DOM.searchInput.addEventListener(
            "input",
            Utils.debounce(() => {
              // Only update if results are already visible
              const resultsSection = document.getElementById('results');
              if (resultsSection && resultsSection.classList.contains('show')) {
                this.handleSearch();
              }
            }, CONFIG.DEBOUNCE_DELAY)
          );

          // Other controls
          DOM.perPageSelect.addEventListener("change", this.handlePerPageChange);
          DOM.clearFiltersBtn.addEventListener("click", this.handleClearFilters);
          DOM.exportBtn.addEventListener("click", () => ExportManager.exportToCSV());

          // Map interaction event listeners using event delegation
          document.addEventListener("click", (e) => {
            // Handle table row clicks
            if (e.target.closest("tr.table-row-clickable")) {
              MapInteraction.handleTableRowClick(e);
            }

            // Handle map fly button clicks
            if (e.target.closest(".map-fly-btn")) {
              MapInteraction.handleMapFlyButtonClick(e);
            }

            // Prevent Bootstrap dropdowns from closing when clicking checkboxes
            if (e.target.closest(".dropdown-item-check")) {
              e.stopPropagation();
            }
          });

          // Category link handler - NEW FUNCTIONALITY
          document.addEventListener('click', (e) => {
            const categoryLink = e.target.closest('[data-category]');
            if (categoryLink) {
              e.preventDefault();
              this.handleCategoryLinkClick(categoryLink);
            }
          });

          // Mobile filter toggle
          const mobileFilterToggleBtn = document.getElementById("mobile-filter-toggle-btn");
          const filterControlsContainer = document.getElementById("filter-controls-container");

          if (mobileFilterToggleBtn && filterControlsContainer) {
            mobileFilterToggleBtn.addEventListener("click", () => {
              filterControlsContainer.classList.toggle("show");

              // Update button text and icon
              const isShown = filterControlsContainer.classList.contains("show");

              if (isShown) {
                mobileFilterToggleBtn.innerHTML = '<i class="bi bi-funnel-fill me-1"></i>Hide Filters';
              } else {
                mobileFilterToggleBtn.innerHTML = '<i class="bi bi-funnel me-1"></i>Filters';
              }
            });
          }

          // Initialize county card manager
          CountyCardManager.initialize();
        },

        handleSearch() {
          AppState.activeFilters.search = DOM.searchInput.value.trim();
          AppState.currentPage = 1;

          // Clear cache when search changes
          APIClient.clearCache();

          // Show results section when search is performed
          ResultsManager.showResultsSection();

          // Hide county search section
          CountyCardManager.hideCountySearch();

          FilterManager.updateFilterChips();
          DataManager.loadData();
        },

        handlePerPageChange() {
          AppState.recordsPerPage = parseInt(DOM.perPageSelect.value);
          AppState.currentPage = 1;
          DataManager.loadData();
        },

        handleClearFilters() {
          FilterManager.clearAll();
          SortManager.clearSort();
          AppState.currentPage = 1;
          
          // Show county search section when filters are cleared
          CountyCardManager.showCountySearch();
          
          // Don't automatically load data - let user choose again
        },

        // NEW METHOD FOR CATEGORY LINKS
        handleCategoryLinkClick(element) {
          const category = element.dataset.category;
          if (!category) return;

          // Clear existing filters and set the category filter
          AppState.activeFilters = {
            search: "",
            County: [],
            "Resource Type": [],
            "Populations Served": [],
            Category: [category] // Set the specific category
          };

          // Clear search input
          DOM.searchInput.value = "";

          // Reset to first page
          AppState.currentPage = 1;

          // Clear cache to ensure fresh data
          APIClient.clearCache();

          // Update all filter UI components
          FilterManager.syncDropdowns('Category');
          FilterManager.updateUI();

          // Hide the county search section
          CountyCardManager.hideCountySearch();

          // Show the results section
          ResultsManager.showResultsSection();

          // Load filtered data
          DataManager.loadData();
        }
      };

      // Application Initialization - UPDATED
      async function initializeApp() {
        try {
          // Initialize DOM cache
          DOM.init();

          // Initialize components
          ViewManager.initialize();
          MapManager.initialize();
          ColumnResizer.initialize();
          SortManager.initialize();
          EventHandlers.initialize();

          // Load filter options but DON'T load data automatically
          await FilterManager.loadFilterOptions();
          
          // Don't call DataManager.loadData() here anymore
          console.log("Application initialized. Awaiting user interaction to show results.");
          
        } catch (error) {
          console.error("Failed to initialize application:", error);
          Utils.hideLoading();
          // Don't show error in results since results are hidden
          console.error("Failed to initialize application");
        }
      }

      // Start the application
      document.addEventListener("DOMContentLoaded", initializeApp);

      // Expose necessary functions to global scope for onclick handlers
      window.PaginationManager = PaginationManager;
      window.FilterManager = FilterManager;
      window.CountyCardManager = CountyCardManager;
      window.ResultsManager = ResultsManager;
</script>
  </body>
</html>
